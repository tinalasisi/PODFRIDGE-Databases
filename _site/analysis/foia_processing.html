<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.32">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Tina Lasisi">
<meta name="dcterms.date" content="2025-07-30">

<title>FOIA Document OCR Processing – PODFRIDGE‑Databases</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js" type="module"></script>
<script src="../site_libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting-37eea08aefeeee20ff55810ff984fec1.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap-c1fac2584b48ed01fb6e278e36375074.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="floating nav-fixed quarto-light">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">PODFRIDGE‑Databases</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../site/index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../site/about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item dropdown ">
    <a class="nav-link dropdown-toggle" href="#" id="nav-menu-analyses" role="link" data-bs-toggle="dropdown" aria-expanded="false">
 <span class="menu-text">Analyses</span>
    </a>
    <ul class="dropdown-menu" aria-labelledby="nav-menu-analyses">    
        <li>
    <a class="dropdown-item" href="../analysis/ndis_scraping.html">
 <span class="dropdown-text">NDIS analysis</span></a>
  </li>  
        <li>
    <a class="dropdown-item" href="../analysis/foia_processing.html">
 <span class="dropdown-text">FOIA processing</span></a>
  </li>  
    </ul>
  </li>
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="3">
   
  <ul>
  <li><a href="#overview" id="toc-overview" class="nav-link active" data-scroll-target="#overview"><span class="header-section-number">1</span> Overview</a></li>
  <li><a href="#materials-and-methods" id="toc-materials-and-methods" class="nav-link" data-scroll-target="#materials-and-methods"><span class="header-section-number">2</span> Materials and Methods</a>
  <ul>
  <li><a href="#data-sources" id="toc-data-sources" class="nav-link" data-scroll-target="#data-sources"><span class="header-section-number">2.1</span> Data Sources</a>
  <ul class="collapse">
  <li><a href="#raw-foia-responses" id="toc-raw-foia-responses" class="nav-link" data-scroll-target="#raw-foia-responses"><span class="header-section-number">2.1.1</span> Raw FOIA Responses</a></li>
  </ul></li>
  <li><a href="#file-structure-and-contents" id="toc-file-structure-and-contents" class="nav-link" data-scroll-target="#file-structure-and-contents"><span class="header-section-number">2.2</span> File Structure and Contents</a>
  <ul class="collapse">
  <li><a href="#state-specific-files-per_statestate_foia_data.csv" id="toc-state-specific-files-per_statestate_foia_data.csv" class="nav-link" data-scroll-target="#state-specific-files-per_statestate_foia_data.csv"><span class="header-section-number">2.2.1</span> State-Specific Files: <code>per_state/[state]_foia_data.csv</code></a></li>
  <li><a href="#state-processing" id="toc-state-processing" class="nav-link" data-scroll-target="#state-processing"><span class="header-section-number">2.2.2</span> State Processing</a></li>
  </ul></li>
  <li><a href="#processing-workflow" id="toc-processing-workflow" class="nav-link" data-scroll-target="#processing-workflow"><span class="header-section-number">2.3</span> Processing workflow</a></li>
  <li><a href="#helper-functions" id="toc-helper-functions" class="nav-link" data-scroll-target="#helper-functions"><span class="header-section-number">2.4</span> Helper Functions</a></li>
  </ul></li>
  <li><a href="#analyses" id="toc-analyses" class="nav-link" data-scroll-target="#analyses"><span class="header-section-number">3</span> Analyses</a>
  <ul>
  <li><a href="#california" id="toc-california" class="nav-link" data-scroll-target="#california"><span class="header-section-number">3.1</span> California</a>
  <ul class="collapse">
  <li><a href="#verifying-that-demographic-counts-match-reported-totals" id="toc-verifying-that-demographic-counts-match-reported-totals" class="nav-link" data-scroll-target="#verifying-that-demographic-counts-match-reported-totals"><span class="header-section-number">3.1.1</span> Verifying that demographic counts match reported totals</a></li>
  <li><a href="#interpreting-the-race-shortfall" id="toc-interpreting-the-race-shortfall" class="nav-link" data-scroll-target="#interpreting-the-race-shortfall"><span class="header-section-number">3.1.2</span> Interpreting the race shortfall</a></li>
  <li><a href="#creating-combined-totals" id="toc-creating-combined-totals" class="nav-link" data-scroll-target="#creating-combined-totals"><span class="header-section-number">3.1.3</span> Creating Combined totals</a></li>
  <li><a href="#preparing-california-data-for-the-combined-dataset" id="toc-preparing-california-data-for-the-combined-dataset" class="nav-link" data-scroll-target="#preparing-california-data-for-the-combined-dataset"><span class="header-section-number">3.1.4</span> Preparing California data for the combined dataset</a></li>
  <li><a href="#calculating-percentages" id="toc-calculating-percentages" class="nav-link" data-scroll-target="#calculating-percentages"><span class="header-section-number">3.1.5</span> Calculating percentages</a></li>
  <li><a href="#visualizing-california-demographics" id="toc-visualizing-california-demographics" class="nav-link" data-scroll-target="#visualizing-california-demographics"><span class="header-section-number">3.1.6</span> Visualizing California demographics</a></li>
  <li><a href="#summary-of-california-processing" id="toc-summary-of-california-processing" class="nav-link" data-scroll-target="#summary-of-california-processing"><span class="header-section-number">3.1.7</span> Summary of California processing</a></li>
  </ul></li>
  <li><a href="#florida" id="toc-florida" class="nav-link" data-scroll-target="#florida"><span class="header-section-number">3.2</span> Florida</a>
  <ul class="collapse">
  <li><a href="#verifying-demographic-consistency" id="toc-verifying-demographic-consistency" class="nav-link" data-scroll-target="#verifying-demographic-consistency"><span class="header-section-number">3.2.1</span> Verifying demographic consistency</a></li>
  <li><a href="#preparing-florida-data-for-the-combined-dataset" id="toc-preparing-florida-data-for-the-combined-dataset" class="nav-link" data-scroll-target="#preparing-florida-data-for-the-combined-dataset"><span class="header-section-number">3.2.2</span> Preparing Florida data for the combined dataset</a></li>
  <li><a href="#visualizing-florida-demographics" id="toc-visualizing-florida-demographics" class="nav-link" data-scroll-target="#visualizing-florida-demographics"><span class="header-section-number">3.2.3</span> Visualizing Florida demographics</a></li>
  <li><a href="#summary-of-florida-processing" id="toc-summary-of-florida-processing" class="nav-link" data-scroll-target="#summary-of-florida-processing"><span class="header-section-number">3.2.4</span> Summary of Florida processing</a></li>
  </ul></li>
  <li><a href="#indiana" id="toc-indiana" class="nav-link" data-scroll-target="#indiana"><span class="header-section-number">3.3</span> Indiana</a>
  <ul class="collapse">
  <li><a href="#understanding-indianas-unique-reporting-structure" id="toc-understanding-indianas-unique-reporting-structure" class="nav-link" data-scroll-target="#understanding-indianas-unique-reporting-structure"><span class="header-section-number">3.3.1</span> Understanding Indiana’s unique reporting structure</a></li>
  <li><a href="#calculating-demographic-counts-from-percentages" id="toc-calculating-demographic-counts-from-percentages" class="nav-link" data-scroll-target="#calculating-demographic-counts-from-percentages"><span class="header-section-number">3.3.2</span> Calculating demographic counts from percentages</a></li>
  <li><a href="#verifying-calculated-totals" id="toc-verifying-calculated-totals" class="nav-link" data-scroll-target="#verifying-calculated-totals"><span class="header-section-number">3.3.3</span> Verifying calculated totals</a></li>
  <li><a href="#visualizing-indiana-demographics" id="toc-visualizing-indiana-demographics" class="nav-link" data-scroll-target="#visualizing-indiana-demographics"><span class="header-section-number">3.3.4</span> Visualizing Indiana demographics</a></li>
  <li><a href="#summary-of-indiana-processing" id="toc-summary-of-indiana-processing" class="nav-link" data-scroll-target="#summary-of-indiana-processing"><span class="header-section-number">3.3.5</span> Summary of Indiana processing</a></li>
  </ul></li>
  <li><a href="#maine" id="toc-maine" class="nav-link" data-scroll-target="#maine"><span class="header-section-number">3.4</span> Maine</a>
  <ul class="collapse">
  <li><a href="#verifying-demographic-consistency-1" id="toc-verifying-demographic-consistency-1" class="nav-link" data-scroll-target="#verifying-demographic-consistency-1"><span class="header-section-number">3.4.1</span> Verifying demographic consistency</a></li>
  <li><a href="#preparing-maine-data-for-the-combined-dataset" id="toc-preparing-maine-data-for-the-combined-dataset" class="nav-link" data-scroll-target="#preparing-maine-data-for-the-combined-dataset"><span class="header-section-number">3.4.2</span> Preparing Maine data for the combined dataset</a></li>
  <li><a href="#visualizing-maine-demographics" id="toc-visualizing-maine-demographics" class="nav-link" data-scroll-target="#visualizing-maine-demographics"><span class="header-section-number">3.4.3</span> Visualizing Maine demographics</a></li>
  <li><a href="#summary-of-maine-processing" id="toc-summary-of-maine-processing" class="nav-link" data-scroll-target="#summary-of-maine-processing"><span class="header-section-number">3.4.4</span> Summary of Maine processing</a></li>
  </ul></li>
  <li><a href="#nevada" id="toc-nevada" class="nav-link" data-scroll-target="#nevada"><span class="header-section-number">3.5</span> Nevada</a>
  <ul class="collapse">
  <li><a href="#verifying-demographic-consistency-2" id="toc-verifying-demographic-consistency-2" class="nav-link" data-scroll-target="#verifying-demographic-consistency-2"><span class="header-section-number">3.5.1</span> Verifying demographic consistency</a></li>
  <li><a href="#preparing-nevada-data-for-the-combined-dataset" id="toc-preparing-nevada-data-for-the-combined-dataset" class="nav-link" data-scroll-target="#preparing-nevada-data-for-the-combined-dataset"><span class="header-section-number">3.5.2</span> Preparing Nevada data for the combined dataset</a></li>
  <li><a href="#visualizing-nevada-demographics" id="toc-visualizing-nevada-demographics" class="nav-link" data-scroll-target="#visualizing-nevada-demographics"><span class="header-section-number">3.5.3</span> Visualizing Nevada demographics</a></li>
  <li><a href="#summary-of-nevada-processing" id="toc-summary-of-nevada-processing" class="nav-link" data-scroll-target="#summary-of-nevada-processing"><span class="header-section-number">3.5.4</span> Summary of Nevada processing</a></li>
  </ul></li>
  <li><a href="#south-dakota" id="toc-south-dakota" class="nav-link" data-scroll-target="#south-dakota"><span class="header-section-number">3.6</span> South Dakota</a>
  <ul class="collapse">
  <li><a href="#examining-the-intersectional-data" id="toc-examining-the-intersectional-data" class="nav-link" data-scroll-target="#examining-the-intersectional-data"><span class="header-section-number">3.6.1</span> Examining the intersectional data</a></li>
  <li><a href="#verifying-demographic-consistency-3" id="toc-verifying-demographic-consistency-3" class="nav-link" data-scroll-target="#verifying-demographic-consistency-3"><span class="header-section-number">3.6.2</span> Verifying demographic consistency</a></li>
  <li><a href="#preparing-south-dakota-data-for-the-combined-dataset" id="toc-preparing-south-dakota-data-for-the-combined-dataset" class="nav-link" data-scroll-target="#preparing-south-dakota-data-for-the-combined-dataset"><span class="header-section-number">3.6.3</span> Preparing South Dakota data for the combined dataset</a></li>
  <li><a href="#visualizing-south-dakota-demographics" id="toc-visualizing-south-dakota-demographics" class="nav-link" data-scroll-target="#visualizing-south-dakota-demographics"><span class="header-section-number">3.6.4</span> Visualizing South Dakota demographics</a></li>
  <li><a href="#summary-of-south-dakota-processing" id="toc-summary-of-south-dakota-processing" class="nav-link" data-scroll-target="#summary-of-south-dakota-processing"><span class="header-section-number">3.6.5</span> Summary of South Dakota processing</a></li>
  </ul></li>
  <li><a href="#texas" id="toc-texas" class="nav-link" data-scroll-target="#texas"><span class="header-section-number">3.7</span> Texas</a>
  <ul class="collapse">
  <li><a href="#verifying-demographic-consistency-4" id="toc-verifying-demographic-consistency-4" class="nav-link" data-scroll-target="#verifying-demographic-consistency-4"><span class="header-section-number">3.7.1</span> Verifying demographic consistency</a></li>
  <li><a href="#creating-combined-totals-1" id="toc-creating-combined-totals-1" class="nav-link" data-scroll-target="#creating-combined-totals-1"><span class="header-section-number">3.7.2</span> Creating Combined totals</a></li>
  <li><a href="#preparing-texas-data-for-the-combined-dataset" id="toc-preparing-texas-data-for-the-combined-dataset" class="nav-link" data-scroll-target="#preparing-texas-data-for-the-combined-dataset"><span class="header-section-number">3.7.3</span> Preparing Texas data for the combined dataset</a></li>
  <li><a href="#calculating-percentages-1" id="toc-calculating-percentages-1" class="nav-link" data-scroll-target="#calculating-percentages-1"><span class="header-section-number">3.7.4</span> Calculating percentages</a></li>
  <li><a href="#visualizing-texas-demographics" id="toc-visualizing-texas-demographics" class="nav-link" data-scroll-target="#visualizing-texas-demographics"><span class="header-section-number">3.7.5</span> Visualizing Texas demographics</a></li>
  <li><a href="#summary-of-texas-processing" id="toc-summary-of-texas-processing" class="nav-link" data-scroll-target="#summary-of-texas-processing"><span class="header-section-number">3.7.6</span> Summary of Texas processing</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#conclusions" id="toc-conclusions" class="nav-link" data-scroll-target="#conclusions"><span class="header-section-number">4</span> Conclusions</a>
  <ul>
  <li><a href="#final-processing-summary" id="toc-final-processing-summary" class="nav-link" data-scroll-target="#final-processing-summary"><span class="header-section-number">4.1</span> Final Processing Summary</a></li>
  <li><a href="#saving-processed-data" id="toc-saving-processed-data" class="nav-link" data-scroll-target="#saving-processed-data"><span class="header-section-number">4.2</span> Saving Processed Data</a></li>
  <li><a href="#key-findings-and-notes" id="toc-key-findings-and-notes" class="nav-link" data-scroll-target="#key-findings-and-notes"><span class="header-section-number">4.3</span> Key Findings and Notes</a></li>
  </ul></li>
  </ul>
</nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">FOIA Document OCR Processing</h1>
<p class="subtitle lead">Processing Murphy &amp; Tong FOIA Documents about State DNA Database Racial Composition</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Tina Lasisi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">July 30, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="overview" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Overview</h1>
<p>This document details the processing of Freedom of Information Act (FOIA) responses from seven U.S. states regarding the demographic composition of their State DNA Index System (SDIS) databases. These responses were obtained by Professor Erin Murphy (NYU Law) in 2018 as part of research on racial disparities in DNA databases.</p>
</section>
<section id="materials-and-methods" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Materials and Methods</h1>
<section id="data-sources" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="data-sources"><span class="header-section-number">2.1</span> Data Sources</h2>
<section id="raw-foia-responses" class="level3" data-number="2.1.1">
<h3 data-number="2.1.1" class="anchored" data-anchor-id="raw-foia-responses"><span class="header-section-number">2.1.1</span> Raw FOIA Responses</h3>
<p>The original FOIA responses are stored in two formats:</p>
<ul>
<li><strong>PDFs</strong>: <code>raw/foia_pdfs/</code> - Original scanned documents</li>
<li><strong>HTML</strong>: <code>raw/foia_html/</code> - OCR’d versions for easier extraction</li>
</ul>
<p>States included:</p>
<ul>
<li>California</li>
<li>Florida<br>
</li>
<li>Indiana</li>
<li>Maine</li>
<li>Nevada</li>
<li>South Dakota</li>
<li>Texas</li>
</ul>
</section>
</section>
<section id="file-structure-and-contents" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="file-structure-and-contents"><span class="header-section-number">2.2</span> File Structure and Contents</h2>
<section id="state-specific-files-per_statestate_foia_data.csv" class="level3" data-number="2.2.1">
<h3 data-number="2.2.1" class="anchored" data-anchor-id="state-specific-files-per_statestate_foia_data.csv"><span class="header-section-number">2.2.1</span> State-Specific Files: <code>per_state/[state]_foia_data.csv</code></h3>
<p><strong>Purpose</strong>: Individual files for each state containing only their reported data.</p>
<p><strong>Structure</strong>: Long format with columns:</p>
<ul>
<li><code>state</code>: State name</li>
<li><code>offender_type</code>: Category of individuals (Convicted Offender, Arrestee, Combined, etc.)</li>
<li><code>variable_category</code>: Type of data (total, gender, race, gender_race)</li>
<li><code>variable_detailed</code>: Specific value (e.g., Male, Female, African American)</li>
<li><code>value</code>: The reported number or percentage</li>
<li><code>value_type</code>: Whether value is a “count” or “percentage”</li>
<li><code>date</code>: Date of data snapshot, if reported</li>
</ul>
</section>
<section id="state-processing" class="level3" data-number="2.2.2">
<h3 data-number="2.2.2" class="anchored" data-anchor-id="state-processing"><span class="header-section-number">2.2.2</span> State Processing</h3>
<div id="cell-setup" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pathlib <span class="im">import</span> Path</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> IPython.display <span class="im">import</span> display, Markdown</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Display options</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.max_columns"</span>, <span class="va">None</span>)</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>pd.set_option(<span class="st">"display.width"</span>, <span class="va">None</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Path to per‑state files (run notebook from analysis/)</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>base_dir   <span class="op">=</span> Path(<span class="st">".."</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>per_state  <span class="op">=</span> base_dir <span class="op">/</span> <span class="st">"output"</span> <span class="op">/</span> <span class="st">"foia"</span> <span class="op">/</span> <span class="st">"per_state"</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Discover available per‑state CSV files</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>state_files <span class="op">=</span> <span class="bu">sorted</span>(per_state.glob(<span class="st">"*_foia_data.csv"</span>))</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">not</span> state_files:</span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">raise</span> <span class="pp">FileNotFoundError</span>(</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>        <span class="ss">f"No per‑state FOIA files found in </span><span class="sc">{</span>per_state<span class="sc">}</span><span class="ss">. "</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"Check the folder path."</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> stem_to_state(stem: <span class="bu">str</span>) <span class="op">-&gt;</span> <span class="bu">str</span>:</span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>    toks <span class="op">=</span> stem.split(<span class="st">"_"</span>)</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">"foia"</span> <span class="kw">in</span> toks:</span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>        toks <span class="op">=</span> toks[:toks.index(<span class="st">"foia"</span>)]</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">" "</span>.join(t.title() <span class="cf">for</span> t <span class="kw">in</span> toks)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>states_available <span class="op">=</span> [stem_to_state(f.stem) <span class="cf">for</span> f <span class="kw">in</span> state_files]</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Found </span><span class="sc">{</span><span class="bu">len</span>(state_files)<span class="sc">}</span><span class="ss"> per‑state files:"</span>)</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> s <span class="kw">in</span> states_available:</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"  •"</span>, s)</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>display(Markdown(</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="ss">f"**States with data loaded:** </span><span class="sc">{</span><span class="st">', '</span><span class="sc">.</span>join(states_available)<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>))</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Initialise empty containers for the loop that follows</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>foia_combined       <span class="op">=</span> pd.DataFrame()   <span class="co"># merged tidy data</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>foia_state_metadata <span class="op">=</span> []               <span class="co"># list of dicts, one per state</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Found 7 per‑state files:
  • California
  • Florida
  • Indiana
  • Maine
  • Nevada
  • South Dakota
  • Texas</code></pre>
</div>
<div id="setup" class="cell-output cell-output-display cell-output-markdown">
<p><strong>States with data loaded:</strong> California, Florida, Indiana, Maine, Nevada, South Dakota, Texas</p>
</div>
</div>
</section>
</section>
<section id="processing-workflow" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="processing-workflow"><span class="header-section-number">2.3</span> Processing workflow</h2>
<p>For transparency, each state file is processed independently then merged into a single <strong>combined long‑format table (<code>foia_combined</code>)</strong>:</p>
<ol type="1">
<li><p><strong>Load one file per state</strong> from <code>output/foia/per_state/</code>.</p></li>
<li><p><strong>Append</strong> its rows to <code>foia_combined</code>. A parallel dataframe, <strong><code>foia_state_metadata</code></strong>, records what each state reported (counts, percentages, which categories) and any state-specific characteristics (e.g.&nbsp;Nevada’s “flags” terminology).</p></li>
<li><p><strong>Quality‑check each state</strong>:</p>
<ul>
<li>verify that race and gender percentages sum to ≈ 100 % when provided,</li>
<li>confirm that demographic counts sum to the state’s reported total profiles,</li>
<li><strong>calculate</strong> any missing counts or percentages and tag those rows <code>value_source = "calculated"</code>.</li>
</ul></li>
<li><p><strong>Save outputs</strong></p>
<ul>
<li><code>output/foia/foia_data_clean.csv</code> — the fully combined tidy table with both reported and calculated values,</li>
<li><code>output/foia/foia_state_metadata.csv</code> — one row per state summarising coverage and caveats. After QC passes, I will freeze <code>foia_data_clean.csv</code> to <code>data/v1.0/foia_state_race_v1.0.csv</code>.</li>
</ul></li>
</ol>
</section>
<section id="helper-functions" class="level2" data-number="2.4">
<h2 data-number="2.4" class="anchored" data-anchor-id="helper-functions"><span class="header-section-number">2.4</span> Helper Functions</h2>
<div id="helper-functions" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define columns needed for foia_combined</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>COLUMNS_NEEDED <span class="op">=</span> [<span class="st">'state'</span>, <span class="st">'offender_type'</span>, <span class="st">'variable_category'</span>, </span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>                  <span class="st">'variable_detailed'</span>, <span class="st">'value'</span>, <span class="st">'value_type'</span>]</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> report_status(df, category):</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    values <span class="op">=</span> df.loc[df[<span class="st">"variable_category"</span>] <span class="op">==</span> category, <span class="st">"value_type"</span>].unique()</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> {<span class="st">"count"</span>, <span class="st">"percentage"</span>}.issubset(values):</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"both"</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">"count"</span> <span class="kw">in</span> values:</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"counts"</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> <span class="st">"percentage"</span> <span class="kw">in</span> values:</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"percentages"</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">"neither"</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> verify_category_totals(df):</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="co">    For every offender_type × variable_category pair:</span></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">      • find the reported total_profiles,</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="co">      • sum all count rows in that category,</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a><span class="co">      • return the difference.</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 1  pull total_profiles per offender_type</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    total_map <span class="op">=</span> (df[(df[<span class="st">"variable_category"</span>] <span class="op">==</span> <span class="st">"total"</span>) <span class="op">&amp;</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>                    (df[<span class="st">"variable_detailed"</span>] <span class="op">==</span> <span class="st">"total_profiles"</span>)]</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>                 .set_index(<span class="st">"offender_type"</span>)[<span class="st">"value"</span>]</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>                 .to_dict())</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 2  sum counts by offender_type and variable_category</span></span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    demo_sum <span class="op">=</span> (df[(df[<span class="st">"value_type"</span>] <span class="op">==</span> <span class="st">"count"</span>) <span class="op">&amp;</span></span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>                   (df[<span class="st">"variable_category"</span>] <span class="op">!=</span> <span class="st">"total"</span>)]</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>                .groupby([<span class="st">"offender_type"</span>, <span class="st">"variable_category"</span>])[<span class="st">"value"</span>]</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>                .<span class="bu">sum</span>()</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>                .rename(<span class="st">"sum_demo_counts"</span>)</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>                .reset_index())</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># 3  attach total_profiles and compute difference</span></span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    demo_sum[<span class="st">"total_profiles"</span>] <span class="op">=</span> demo_sum[<span class="st">"offender_type"</span>].<span class="bu">map</span>(total_map)</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    demo_sum[<span class="st">"difference"</span>] <span class="op">=</span> demo_sum[<span class="st">"total_profiles"</span>] <span class="op">-</span> demo_sum[<span class="st">"sum_demo_counts"</span>]</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># tidy columns order</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> demo_sum[[<span class="st">"offender_type"</span>,</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"variable_category"</span>,</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"total_profiles"</span>,</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"sum_demo_counts"</span>,</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>                     <span class="st">"difference"</span>]]</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_combined_totals(df, state_name):</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate Combined totals by summing across offender types.</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a dataframe of Combined rows to add.</span></span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all counts</span></span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    counts_df <span class="op">=</span> df[(df[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'count'</span>)].copy()</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Group by variable_category and variable_detailed, sum values</span></span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    combined_sums <span class="op">=</span> (counts_df.groupby([<span class="st">'variable_category'</span>, <span class="st">'variable_detailed'</span>])[<span class="st">'value'</span>]</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>                     .<span class="bu">sum</span>()</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>                     .reset_index())</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create Combined rows</span></span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    combined_rows <span class="op">=</span> []</span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> _, row <span class="kw">in</span> combined_sums.iterrows():</span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>        combined_rows.append({</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>            <span class="st">'state'</span>: state_name,</span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>            <span class="st">'offender_type'</span>: <span class="st">'Combined'</span>,</span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>            <span class="st">'variable_category'</span>: row[<span class="st">'variable_category'</span>],</span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>            <span class="st">'variable_detailed'</span>: row[<span class="st">'variable_detailed'</span>],</span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>            <span class="st">'value'</span>: row[<span class="st">'value'</span>],</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>            <span class="st">'value_type'</span>: <span class="st">'count'</span>,</span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>            <span class="st">'value_source'</span>: <span class="st">'calculated'</span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>        })</span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(combined_rows)</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_percentages(df_combined, state_name):</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate percentages for all demographic categories.</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a dataframe of percentage rows to add.</span></span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get total profiles for each offender type</span></span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    totals_map <span class="op">=</span> (df_combined[</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>        (df_combined[<span class="st">'state'</span>] <span class="op">==</span> state_name) <span class="op">&amp;</span></span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>        (df_combined[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'total'</span>) <span class="op">&amp;</span></span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>        (df_combined[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'total_profiles'</span>)</span>
<span id="cb3-87"><a href="#cb3-87" aria-hidden="true" tabindex="-1"></a>    ].set_index(<span class="st">'offender_type'</span>)[<span class="st">'value'</span>].to_dict())</span>
<span id="cb3-88"><a href="#cb3-88" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-89"><a href="#cb3-89" aria-hidden="true" tabindex="-1"></a>    percentage_rows <span class="op">=</span> []</span>
<span id="cb3-90"><a href="#cb3-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-91"><a href="#cb3-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> offender_type, total <span class="kw">in</span> totals_map.items():</span>
<span id="cb3-92"><a href="#cb3-92" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get all demographic counts</span></span>
<span id="cb3-93"><a href="#cb3-93" aria-hidden="true" tabindex="-1"></a>        demo_data <span class="op">=</span> df_combined[</span>
<span id="cb3-94"><a href="#cb3-94" aria-hidden="true" tabindex="-1"></a>            (df_combined[<span class="st">'state'</span>] <span class="op">==</span> state_name) <span class="op">&amp;</span></span>
<span id="cb3-95"><a href="#cb3-95" aria-hidden="true" tabindex="-1"></a>            (df_combined[<span class="st">'offender_type'</span>] <span class="op">==</span> offender_type) <span class="op">&amp;</span></span>
<span id="cb3-96"><a href="#cb3-96" aria-hidden="true" tabindex="-1"></a>            (df_combined[<span class="st">'variable_category'</span>].isin([<span class="st">'gender'</span>, <span class="st">'race'</span>])) <span class="op">&amp;</span></span>
<span id="cb3-97"><a href="#cb3-97" aria-hidden="true" tabindex="-1"></a>            (df_combined[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'count'</span>)</span>
<span id="cb3-98"><a href="#cb3-98" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb3-99"><a href="#cb3-99" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-100"><a href="#cb3-100" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate percentage for each</span></span>
<span id="cb3-101"><a href="#cb3-101" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, row <span class="kw">in</span> demo_data.iterrows():</span>
<span id="cb3-102"><a href="#cb3-102" aria-hidden="true" tabindex="-1"></a>            percentage <span class="op">=</span> (row[<span class="st">'value'</span>] <span class="op">/</span> total) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb3-103"><a href="#cb3-103" aria-hidden="true" tabindex="-1"></a>            percentage_rows.append({</span>
<span id="cb3-104"><a href="#cb3-104" aria-hidden="true" tabindex="-1"></a>                <span class="st">'state'</span>: state_name,</span>
<span id="cb3-105"><a href="#cb3-105" aria-hidden="true" tabindex="-1"></a>                <span class="st">'offender_type'</span>: offender_type,</span>
<span id="cb3-106"><a href="#cb3-106" aria-hidden="true" tabindex="-1"></a>                <span class="st">'variable_category'</span>: row[<span class="st">'variable_category'</span>],</span>
<span id="cb3-107"><a href="#cb3-107" aria-hidden="true" tabindex="-1"></a>                <span class="st">'variable_detailed'</span>: row[<span class="st">'variable_detailed'</span>],</span>
<span id="cb3-108"><a href="#cb3-108" aria-hidden="true" tabindex="-1"></a>                <span class="st">'value'</span>: <span class="bu">round</span>(percentage, <span class="dv">2</span>),</span>
<span id="cb3-109"><a href="#cb3-109" aria-hidden="true" tabindex="-1"></a>                <span class="st">'value_type'</span>: <span class="st">'percentage'</span>,</span>
<span id="cb3-110"><a href="#cb3-110" aria-hidden="true" tabindex="-1"></a>                <span class="st">'value_source'</span>: <span class="st">'calculated'</span></span>
<span id="cb3-111"><a href="#cb3-111" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb3-112"><a href="#cb3-112" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-113"><a href="#cb3-113" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(percentage_rows)</span>
<span id="cb3-114"><a href="#cb3-114" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-115"><a href="#cb3-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-116"><a href="#cb3-116" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> calculate_counts_from_percentages(df_combined, state_name):</span>
<span id="cb3-117"><a href="#cb3-117" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-118"><a href="#cb3-118" aria-hidden="true" tabindex="-1"></a><span class="co">    Calculate counts from percentages when only percentages are provided.</span></span>
<span id="cb3-119"><a href="#cb3-119" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns a dataframe of count rows to add.</span></span>
<span id="cb3-120"><a href="#cb3-120" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-121"><a href="#cb3-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get total profiles for each offender type</span></span>
<span id="cb3-122"><a href="#cb3-122" aria-hidden="true" tabindex="-1"></a>    totals_map <span class="op">=</span> (df_combined[</span>
<span id="cb3-123"><a href="#cb3-123" aria-hidden="true" tabindex="-1"></a>        (df_combined[<span class="st">'state'</span>] <span class="op">==</span> state_name) <span class="op">&amp;</span></span>
<span id="cb3-124"><a href="#cb3-124" aria-hidden="true" tabindex="-1"></a>        (df_combined[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'total'</span>) <span class="op">&amp;</span></span>
<span id="cb3-125"><a href="#cb3-125" aria-hidden="true" tabindex="-1"></a>        (df_combined[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'total_profiles'</span>)</span>
<span id="cb3-126"><a href="#cb3-126" aria-hidden="true" tabindex="-1"></a>    ].set_index(<span class="st">'offender_type'</span>)[<span class="st">'value'</span>].to_dict())</span>
<span id="cb3-127"><a href="#cb3-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-128"><a href="#cb3-128" aria-hidden="true" tabindex="-1"></a>    count_rows <span class="op">=</span> []</span>
<span id="cb3-129"><a href="#cb3-129" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-130"><a href="#cb3-130" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> offender_type, total <span class="kw">in</span> totals_map.items():</span>
<span id="cb3-131"><a href="#cb3-131" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Get all demographic percentages</span></span>
<span id="cb3-132"><a href="#cb3-132" aria-hidden="true" tabindex="-1"></a>        demo_data <span class="op">=</span> df_combined[</span>
<span id="cb3-133"><a href="#cb3-133" aria-hidden="true" tabindex="-1"></a>            (df_combined[<span class="st">'state'</span>] <span class="op">==</span> state_name) <span class="op">&amp;</span></span>
<span id="cb3-134"><a href="#cb3-134" aria-hidden="true" tabindex="-1"></a>            (df_combined[<span class="st">'offender_type'</span>] <span class="op">==</span> offender_type) <span class="op">&amp;</span></span>
<span id="cb3-135"><a href="#cb3-135" aria-hidden="true" tabindex="-1"></a>            (df_combined[<span class="st">'variable_category'</span>].isin([<span class="st">'gender'</span>, <span class="st">'race'</span>])) <span class="op">&amp;</span></span>
<span id="cb3-136"><a href="#cb3-136" aria-hidden="true" tabindex="-1"></a>            (df_combined[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'percentage'</span>)</span>
<span id="cb3-137"><a href="#cb3-137" aria-hidden="true" tabindex="-1"></a>        ]</span>
<span id="cb3-138"><a href="#cb3-138" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-139"><a href="#cb3-139" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate count for each</span></span>
<span id="cb3-140"><a href="#cb3-140" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _, row <span class="kw">in</span> demo_data.iterrows():</span>
<span id="cb3-141"><a href="#cb3-141" aria-hidden="true" tabindex="-1"></a>            count <span class="op">=</span> <span class="bu">round</span>(total <span class="op">*</span> (row[<span class="st">'value'</span>] <span class="op">/</span> <span class="dv">100</span>))</span>
<span id="cb3-142"><a href="#cb3-142" aria-hidden="true" tabindex="-1"></a>            count_rows.append({</span>
<span id="cb3-143"><a href="#cb3-143" aria-hidden="true" tabindex="-1"></a>                <span class="st">'state'</span>: state_name,</span>
<span id="cb3-144"><a href="#cb3-144" aria-hidden="true" tabindex="-1"></a>                <span class="st">'offender_type'</span>: offender_type,</span>
<span id="cb3-145"><a href="#cb3-145" aria-hidden="true" tabindex="-1"></a>                <span class="st">'variable_category'</span>: row[<span class="st">'variable_category'</span>],</span>
<span id="cb3-146"><a href="#cb3-146" aria-hidden="true" tabindex="-1"></a>                <span class="st">'variable_detailed'</span>: row[<span class="st">'variable_detailed'</span>],</span>
<span id="cb3-147"><a href="#cb3-147" aria-hidden="true" tabindex="-1"></a>                <span class="st">'value'</span>: <span class="bu">int</span>(count),</span>
<span id="cb3-148"><a href="#cb3-148" aria-hidden="true" tabindex="-1"></a>                <span class="st">'value_type'</span>: <span class="st">'count'</span>,</span>
<span id="cb3-149"><a href="#cb3-149" aria-hidden="true" tabindex="-1"></a>                <span class="st">'value_source'</span>: <span class="st">'calculated'</span></span>
<span id="cb3-150"><a href="#cb3-150" aria-hidden="true" tabindex="-1"></a>            })</span>
<span id="cb3-151"><a href="#cb3-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-152"><a href="#cb3-152" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.DataFrame(count_rows)</span>
<span id="cb3-153"><a href="#cb3-153" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-154"><a href="#cb3-154" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-155"><a href="#cb3-155" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> standardize_offender_types(df):</span>
<span id="cb3-156"><a href="#cb3-156" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-157"><a href="#cb3-157" aria-hidden="true" tabindex="-1"></a><span class="co">    Standardize offender type terminology across states.</span></span>
<span id="cb3-158"><a href="#cb3-158" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-159"><a href="#cb3-159" aria-hidden="true" tabindex="-1"></a>    replacements <span class="op">=</span> {</span>
<span id="cb3-160"><a href="#cb3-160" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Offenders'</span>: <span class="st">'Convicted Offender'</span>,</span>
<span id="cb3-161"><a href="#cb3-161" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Convicted offenders'</span>: <span class="st">'Convicted Offender'</span>,</span>
<span id="cb3-162"><a href="#cb3-162" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Arrested offender'</span>: <span class="st">'Arrestee'</span>,</span>
<span id="cb3-163"><a href="#cb3-163" aria-hidden="true" tabindex="-1"></a>        <span class="st">'All'</span>: <span class="st">'Combined'</span></span>
<span id="cb3-164"><a href="#cb3-164" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-165"><a href="#cb3-165" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-166"><a href="#cb3-166" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> df.copy()</span>
<span id="cb3-167"><a href="#cb3-167" aria-hidden="true" tabindex="-1"></a>    df[<span class="st">'offender_type'</span>] <span class="op">=</span> df[<span class="st">'offender_type'</span>].replace(replacements)</span>
<span id="cb3-168"><a href="#cb3-168" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df</span>
<span id="cb3-169"><a href="#cb3-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-170"><a href="#cb3-170" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-171"><a href="#cb3-171" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> prepare_state_for_combined(df, state_name):</span>
<span id="cb3-172"><a href="#cb3-172" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-173"><a href="#cb3-173" aria-hidden="true" tabindex="-1"></a><span class="co">    Prepare state data for appending to foia_combined.</span></span>
<span id="cb3-174"><a href="#cb3-174" aria-hidden="true" tabindex="-1"></a><span class="co">    Selects only needed columns and adds value_source if missing.</span></span>
<span id="cb3-175"><a href="#cb3-175" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-176"><a href="#cb3-176" aria-hidden="true" tabindex="-1"></a>    df_prepared <span class="op">=</span> df[COLUMNS_NEEDED].copy()</span>
<span id="cb3-177"><a href="#cb3-177" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-178"><a href="#cb3-178" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add value_source if not present</span></span>
<span id="cb3-179"><a href="#cb3-179" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'value_source'</span> <span class="kw">not</span> <span class="kw">in</span> df_prepared.columns:</span>
<span id="cb3-180"><a href="#cb3-180" aria-hidden="true" tabindex="-1"></a>        df_prepared[<span class="st">'value_source'</span>] <span class="op">=</span> <span class="st">'reported'</span></span>
<span id="cb3-181"><a href="#cb3-181" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-182"><a href="#cb3-182" aria-hidden="true" tabindex="-1"></a>        df_prepared[<span class="st">'value_source'</span>] <span class="op">=</span> df_prepared[<span class="st">'value_source'</span>].fillna(<span class="st">'reported'</span>)</span>
<span id="cb3-183"><a href="#cb3-183" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-184"><a href="#cb3-184" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> df_prepared</span>
<span id="cb3-185"><a href="#cb3-185" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-186"><a href="#cb3-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-187"><a href="#cb3-187" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> format_compact(x, p<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb3-188"><a href="#cb3-188" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-189"><a href="#cb3-189" aria-hidden="true" tabindex="-1"></a><span class="co">    Format numbers in compact notation (k for thousands, M for millions).</span></span>
<span id="cb3-190"><a href="#cb3-190" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb3-191"><a href="#cb3-191" aria-hidden="true" tabindex="-1"></a><span class="co">    Args:</span></span>
<span id="cb3-192"><a href="#cb3-192" aria-hidden="true" tabindex="-1"></a><span class="co">        x: The number to format</span></span>
<span id="cb3-193"><a href="#cb3-193" aria-hidden="true" tabindex="-1"></a><span class="co">        p: Position parameter (not used, but kept for compatibility with matplotlib)</span></span>
<span id="cb3-194"><a href="#cb3-194" aria-hidden="true" tabindex="-1"></a><span class="co">    </span></span>
<span id="cb3-195"><a href="#cb3-195" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns:</span></span>
<span id="cb3-196"><a href="#cb3-196" aria-hidden="true" tabindex="-1"></a><span class="co">        Formatted string with k/M suffix</span></span>
<span id="cb3-197"><a href="#cb3-197" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-198"><a href="#cb3-198" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> x <span class="op">&gt;=</span> <span class="dv">1000000</span>:</span>
<span id="cb3-199"><a href="#cb3-199" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For millions, show one decimal place if not a whole million</span></span>
<span id="cb3-200"><a href="#cb3-200" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'</span><span class="sc">{</span>x<span class="op">/</span><span class="dv">1000000</span><span class="sc">:.1f}</span><span class="ss">M'</span> <span class="cf">if</span> x<span class="op">/</span><span class="dv">1000000</span> <span class="op">!=</span> <span class="bu">int</span>(x<span class="op">/</span><span class="dv">1000000</span>) <span class="cf">else</span> <span class="ss">f'</span><span class="sc">{</span><span class="bu">int</span>(x<span class="op">/</span><span class="dv">1000000</span>)<span class="sc">}</span><span class="ss">M'</span></span>
<span id="cb3-201"><a href="#cb3-201" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elif</span> x <span class="op">&gt;=</span> <span class="dv">1000</span>:</span>
<span id="cb3-202"><a href="#cb3-202" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For thousands, always show as integer</span></span>
<span id="cb3-203"><a href="#cb3-203" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'</span><span class="sc">{</span><span class="bu">int</span>(x<span class="op">/</span><span class="dv">1000</span>)<span class="sc">}</span><span class="ss">k'</span></span>
<span id="cb3-204"><a href="#cb3-204" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-205"><a href="#cb3-205" aria-hidden="true" tabindex="-1"></a>        <span class="co"># For values under 1000, show as integer</span></span>
<span id="cb3-206"><a href="#cb3-206" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="ss">f'</span><span class="sc">{</span><span class="bu">int</span>(x)<span class="sc">}</span><span class="ss">'</span></span>
<span id="cb3-207"><a href="#cb3-207" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-208"><a href="#cb3-208" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-209"><a href="#cb3-209" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_state_visualizations(df_combined, state_name):</span>
<span id="cb3-210"><a href="#cb3-210" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-211"><a href="#cb3-211" aria-hidden="true" tabindex="-1"></a><span class="co">    Create count and percentage pie charts for a state.</span></span>
<span id="cb3-212"><a href="#cb3-212" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-213"><a href="#cb3-213" aria-hidden="true" tabindex="-1"></a>    state_data <span class="op">=</span> df_combined[df_combined[<span class="st">'state'</span>] <span class="op">==</span> state_name]</span>
<span id="cb3-214"><a href="#cb3-214" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-215"><a href="#cb3-215" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Determine offender types for this state</span></span>
<span id="cb3-216"><a href="#cb3-216" aria-hidden="true" tabindex="-1"></a>    offender_types <span class="op">=</span> <span class="bu">sorted</span>(state_data[<span class="st">'offender_type'</span>].unique())</span>
<span id="cb3-217"><a href="#cb3-217" aria-hidden="true" tabindex="-1"></a>    n_types <span class="op">=</span> <span class="bu">len</span>(offender_types)</span>
<span id="cb3-218"><a href="#cb3-218" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-219"><a href="#cb3-219" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create figure</span></span>
<span id="cb3-220"><a href="#cb3-220" aria-hidden="true" tabindex="-1"></a>    fig, axes <span class="op">=</span> plt.subplots(<span class="dv">4</span>, n_types, figsize<span class="op">=</span>(<span class="dv">5</span><span class="op">*</span>n_types, <span class="dv">16</span>))</span>
<span id="cb3-221"><a href="#cb3-221" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> n_types <span class="op">==</span> <span class="dv">1</span>:</span>
<span id="cb3-222"><a href="#cb3-222" aria-hidden="true" tabindex="-1"></a>        axes <span class="op">=</span> axes.reshape(<span class="op">-</span><span class="dv">1</span>, <span class="dv">1</span>)</span>
<span id="cb3-223"><a href="#cb3-223" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-224"><a href="#cb3-224" aria-hidden="true" tabindex="-1"></a>    fig.suptitle(<span class="ss">f'</span><span class="sc">{</span>state_name<span class="sc">}</span><span class="ss"> DNA Database Demographics - Counts and Percentages'</span>, fontsize<span class="op">=</span><span class="dv">18</span>)</span>
<span id="cb3-225"><a href="#cb3-225" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-226"><a href="#cb3-226" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create pie charts for each metric</span></span>
<span id="cb3-227"><a href="#cb3-227" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, offender_type <span class="kw">in</span> <span class="bu">enumerate</span>(offender_types):</span>
<span id="cb3-228"><a href="#cb3-228" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Gender counts</span></span>
<span id="cb3-229"><a href="#cb3-229" aria-hidden="true" tabindex="-1"></a>        create_pie_chart(axes[<span class="dv">0</span>, i], state_data, offender_type, <span class="st">'gender'</span>, <span class="st">'count'</span>, </span>
<span id="cb3-230"><a href="#cb3-230" aria-hidden="true" tabindex="-1"></a>                        <span class="ss">f'</span><span class="sc">{</span>offender_type<span class="sc">}</span><span class="ch">\n</span><span class="ss">Gender Counts'</span>, show_values<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-231"><a href="#cb3-231" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-232"><a href="#cb3-232" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Gender percentages</span></span>
<span id="cb3-233"><a href="#cb3-233" aria-hidden="true" tabindex="-1"></a>        create_pie_chart(axes[<span class="dv">1</span>, i], state_data, offender_type, <span class="st">'gender'</span>, <span class="st">'percentage'</span>,</span>
<span id="cb3-234"><a href="#cb3-234" aria-hidden="true" tabindex="-1"></a>                        <span class="ss">f'</span><span class="sc">{</span>offender_type<span class="sc">}</span><span class="ch">\n</span><span class="ss">Gender Percentages'</span>)</span>
<span id="cb3-235"><a href="#cb3-235" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-236"><a href="#cb3-236" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Race counts</span></span>
<span id="cb3-237"><a href="#cb3-237" aria-hidden="true" tabindex="-1"></a>        create_pie_chart(axes[<span class="dv">2</span>, i], state_data, offender_type, <span class="st">'race'</span>, <span class="st">'count'</span>,</span>
<span id="cb3-238"><a href="#cb3-238" aria-hidden="true" tabindex="-1"></a>                        <span class="ss">f'</span><span class="sc">{</span>offender_type<span class="sc">}</span><span class="ch">\n</span><span class="ss">Race Counts'</span>, show_values<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb3-239"><a href="#cb3-239" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-240"><a href="#cb3-240" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Race percentages</span></span>
<span id="cb3-241"><a href="#cb3-241" aria-hidden="true" tabindex="-1"></a>        create_pie_chart(axes[<span class="dv">3</span>, i], state_data, offender_type, <span class="st">'race'</span>, <span class="st">'percentage'</span>,</span>
<span id="cb3-242"><a href="#cb3-242" aria-hidden="true" tabindex="-1"></a>                        <span class="ss">f'</span><span class="sc">{</span>offender_type<span class="sc">}</span><span class="ch">\n</span><span class="ss">Race Percentages'</span>)</span>
<span id="cb3-243"><a href="#cb3-243" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-244"><a href="#cb3-244" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb3-245"><a href="#cb3-245" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb3-246"><a href="#cb3-246" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-247"><a href="#cb3-247" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display count summary</span></span>
<span id="cb3-248"><a href="#cb3-248" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>state_name<span class="sc">}</span><span class="ss"> profile counts by offender type:"</span>)</span>
<span id="cb3-249"><a href="#cb3-249" aria-hidden="true" tabindex="-1"></a>    count_summary <span class="op">=</span> state_data[</span>
<span id="cb3-250"><a href="#cb3-250" aria-hidden="true" tabindex="-1"></a>        (state_data[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'total'</span>) <span class="op">&amp;</span></span>
<span id="cb3-251"><a href="#cb3-251" aria-hidden="true" tabindex="-1"></a>        (state_data[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'total_profiles'</span>) <span class="op">&amp;</span></span>
<span id="cb3-252"><a href="#cb3-252" aria-hidden="true" tabindex="-1"></a>        (state_data[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'count'</span>)</span>
<span id="cb3-253"><a href="#cb3-253" aria-hidden="true" tabindex="-1"></a>    ][[<span class="st">'offender_type'</span>, <span class="st">'value'</span>]].set_index(<span class="st">'offender_type'</span>)</span>
<span id="cb3-254"><a href="#cb3-254" aria-hidden="true" tabindex="-1"></a>    count_summary.columns <span class="op">=</span> [<span class="st">'Total Profiles'</span>]</span>
<span id="cb3-255"><a href="#cb3-255" aria-hidden="true" tabindex="-1"></a>    count_summary[<span class="st">'Total Profiles'</span>] <span class="op">=</span> count_summary[<span class="st">'Total Profiles'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span>x<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb3-256"><a href="#cb3-256" aria-hidden="true" tabindex="-1"></a>    display(count_summary)</span>
<span id="cb3-257"><a href="#cb3-257" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-258"><a href="#cb3-258" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-259"><a href="#cb3-259" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_pie_chart(ax, data, offender_type, category, value_type, title, show_values<span class="op">=</span><span class="va">False</span>):</span>
<span id="cb3-260"><a href="#cb3-260" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-261"><a href="#cb3-261" aria-hidden="true" tabindex="-1"></a><span class="co">    Helper to create a single pie chart.</span></span>
<span id="cb3-262"><a href="#cb3-262" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-263"><a href="#cb3-263" aria-hidden="true" tabindex="-1"></a>    chart_data <span class="op">=</span> data[</span>
<span id="cb3-264"><a href="#cb3-264" aria-hidden="true" tabindex="-1"></a>        (data[<span class="st">'offender_type'</span>] <span class="op">==</span> offender_type) <span class="op">&amp;</span></span>
<span id="cb3-265"><a href="#cb3-265" aria-hidden="true" tabindex="-1"></a>        (data[<span class="st">'variable_category'</span>] <span class="op">==</span> category) <span class="op">&amp;</span></span>
<span id="cb3-266"><a href="#cb3-266" aria-hidden="true" tabindex="-1"></a>        (data[<span class="st">'value_type'</span>] <span class="op">==</span> value_type)</span>
<span id="cb3-267"><a href="#cb3-267" aria-hidden="true" tabindex="-1"></a>    ].sort_values(<span class="st">'value'</span>, ascending<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb3-268"><a href="#cb3-268" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-269"><a href="#cb3-269" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">len</span>(chart_data) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb3-270"><a href="#cb3-270" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> show_values <span class="kw">and</span> value_type <span class="op">==</span> <span class="st">'count'</span>:</span>
<span id="cb3-271"><a href="#cb3-271" aria-hidden="true" tabindex="-1"></a>            labels <span class="op">=</span> [<span class="ss">f"</span><span class="sc">{</span>row[<span class="st">'variable_detailed'</span>]<span class="sc">}</span><span class="ch">\n</span><span class="ss">(</span><span class="sc">{</span>row[<span class="st">'value'</span>]<span class="sc">:,.0f}</span><span class="ss">)"</span> </span>
<span id="cb3-272"><a href="#cb3-272" aria-hidden="true" tabindex="-1"></a>                     <span class="cf">for</span> _, row <span class="kw">in</span> chart_data.iterrows()]</span>
<span id="cb3-273"><a href="#cb3-273" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb3-274"><a href="#cb3-274" aria-hidden="true" tabindex="-1"></a>            labels <span class="op">=</span> chart_data[<span class="st">'variable_detailed'</span>]</span>
<span id="cb3-275"><a href="#cb3-275" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-276"><a href="#cb3-276" aria-hidden="true" tabindex="-1"></a>        colors <span class="op">=</span> plt.cm.Set3(<span class="bu">range</span>(<span class="bu">len</span>(chart_data)))</span>
<span id="cb3-277"><a href="#cb3-277" aria-hidden="true" tabindex="-1"></a>        wedges, texts, autotexts <span class="op">=</span> ax.pie(chart_data[<span class="st">'value'</span>], </span>
<span id="cb3-278"><a href="#cb3-278" aria-hidden="true" tabindex="-1"></a>                                          labels<span class="op">=</span>labels,</span>
<span id="cb3-279"><a href="#cb3-279" aria-hidden="true" tabindex="-1"></a>                                          autopct<span class="op">=</span><span class="st">'</span><span class="sc">%1.1f%%</span><span class="st">'</span>,</span>
<span id="cb3-280"><a href="#cb3-280" aria-hidden="true" tabindex="-1"></a>                                          startangle<span class="op">=</span><span class="dv">90</span>,</span>
<span id="cb3-281"><a href="#cb3-281" aria-hidden="true" tabindex="-1"></a>                                          colors<span class="op">=</span>colors)</span>
<span id="cb3-282"><a href="#cb3-282" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-283"><a href="#cb3-283" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Adjust text size for readability</span></span>
<span id="cb3-284"><a href="#cb3-284" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> text <span class="kw">in</span> texts:</span>
<span id="cb3-285"><a href="#cb3-285" aria-hidden="true" tabindex="-1"></a>            text.set_fontsize(<span class="dv">10</span> <span class="cf">if</span> category <span class="op">==</span> <span class="st">'race'</span> <span class="cf">else</span> <span class="dv">11</span>)</span>
<span id="cb3-286"><a href="#cb3-286" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> autotext <span class="kw">in</span> autotexts:</span>
<span id="cb3-287"><a href="#cb3-287" aria-hidden="true" tabindex="-1"></a>            autotext.set_fontsize(<span class="dv">10</span>)</span>
<span id="cb3-288"><a href="#cb3-288" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-289"><a href="#cb3-289" aria-hidden="true" tabindex="-1"></a>        ax.set_title(title)</span>
<span id="cb3-290"><a href="#cb3-290" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-291"><a href="#cb3-291" aria-hidden="true" tabindex="-1"></a>        ax.text(<span class="fl">0.5</span>, <span class="fl">0.5</span>, <span class="st">'No data'</span>, ha<span class="op">=</span><span class="st">'center'</span>, va<span class="op">=</span><span class="st">'center'</span>, transform<span class="op">=</span>ax.transAxes)</span>
<span id="cb3-292"><a href="#cb3-292" aria-hidden="true" tabindex="-1"></a>        ax.set_title(title)</span>
<span id="cb3-293"><a href="#cb3-293" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-294"><a href="#cb3-294" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-295"><a href="#cb3-295" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> verify_percentage_consistency(df_combined, state_name):</span>
<span id="cb3-296"><a href="#cb3-296" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-297"><a href="#cb3-297" aria-hidden="true" tabindex="-1"></a><span class="co">    Verify that reported percentages match calculated percentages (within tolerance).</span></span>
<span id="cb3-298"><a href="#cb3-298" aria-hidden="true" tabindex="-1"></a><span class="co">    Returns True if consistent, False otherwise.</span></span>
<span id="cb3-299"><a href="#cb3-299" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-300"><a href="#cb3-300" aria-hidden="true" tabindex="-1"></a>    state_data <span class="op">=</span> df_combined[df_combined[<span class="st">'state'</span>] <span class="op">==</span> state_name]</span>
<span id="cb3-301"><a href="#cb3-301" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-302"><a href="#cb3-302" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all offender types that have both counts and percentages</span></span>
<span id="cb3-303"><a href="#cb3-303" aria-hidden="true" tabindex="-1"></a>    offender_types <span class="op">=</span> state_data[<span class="st">'offender_type'</span>].unique()</span>
<span id="cb3-304"><a href="#cb3-304" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-305"><a href="#cb3-305" aria-hidden="true" tabindex="-1"></a>    consistency_results <span class="op">=</span> []</span>
<span id="cb3-306"><a href="#cb3-306" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-307"><a href="#cb3-307" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> offender_type <span class="kw">in</span> offender_types:</span>
<span id="cb3-308"><a href="#cb3-308" aria-hidden="true" tabindex="-1"></a>        offender_data <span class="op">=</span> state_data[state_data[<span class="st">'offender_type'</span>] <span class="op">==</span> offender_type]</span>
<span id="cb3-309"><a href="#cb3-309" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-310"><a href="#cb3-310" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Check if we have both reported and calculated percentages</span></span>
<span id="cb3-311"><a href="#cb3-311" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> category <span class="kw">in</span> [<span class="st">'gender'</span>, <span class="st">'race'</span>]:</span>
<span id="cb3-312"><a href="#cb3-312" aria-hidden="true" tabindex="-1"></a>            reported_pcts <span class="op">=</span> offender_data[</span>
<span id="cb3-313"><a href="#cb3-313" aria-hidden="true" tabindex="-1"></a>                (offender_data[<span class="st">'variable_category'</span>] <span class="op">==</span> category) <span class="op">&amp;</span></span>
<span id="cb3-314"><a href="#cb3-314" aria-hidden="true" tabindex="-1"></a>                (offender_data[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'percentage'</span>) <span class="op">&amp;</span></span>
<span id="cb3-315"><a href="#cb3-315" aria-hidden="true" tabindex="-1"></a>                (offender_data[<span class="st">'value_source'</span>] <span class="op">==</span> <span class="st">'reported'</span>)</span>
<span id="cb3-316"><a href="#cb3-316" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb3-317"><a href="#cb3-317" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-318"><a href="#cb3-318" aria-hidden="true" tabindex="-1"></a>            calculated_pcts <span class="op">=</span> offender_data[</span>
<span id="cb3-319"><a href="#cb3-319" aria-hidden="true" tabindex="-1"></a>                (offender_data[<span class="st">'variable_category'</span>] <span class="op">==</span> category) <span class="op">&amp;</span></span>
<span id="cb3-320"><a href="#cb3-320" aria-hidden="true" tabindex="-1"></a>                (offender_data[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'percentage'</span>) <span class="op">&amp;</span></span>
<span id="cb3-321"><a href="#cb3-321" aria-hidden="true" tabindex="-1"></a>                (offender_data[<span class="st">'value_source'</span>] <span class="op">==</span> <span class="st">'calculated'</span>)</span>
<span id="cb3-322"><a href="#cb3-322" aria-hidden="true" tabindex="-1"></a>            ]</span>
<span id="cb3-323"><a href="#cb3-323" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-324"><a href="#cb3-324" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="bu">len</span>(reported_pcts) <span class="op">&gt;</span> <span class="dv">0</span> <span class="kw">and</span> <span class="bu">len</span>(calculated_pcts) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb3-325"><a href="#cb3-325" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Compare each demographic value</span></span>
<span id="cb3-326"><a href="#cb3-326" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> _, rep_row <span class="kw">in</span> reported_pcts.iterrows():</span>
<span id="cb3-327"><a href="#cb3-327" aria-hidden="true" tabindex="-1"></a>                    calc_match <span class="op">=</span> calculated_pcts[</span>
<span id="cb3-328"><a href="#cb3-328" aria-hidden="true" tabindex="-1"></a>                        calculated_pcts[<span class="st">'variable_detailed'</span>] <span class="op">==</span> rep_row[<span class="st">'variable_detailed'</span>]</span>
<span id="cb3-329"><a href="#cb3-329" aria-hidden="true" tabindex="-1"></a>                    ]</span>
<span id="cb3-330"><a href="#cb3-330" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="bu">len</span>(calc_match) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb3-331"><a href="#cb3-331" aria-hidden="true" tabindex="-1"></a>                        diff <span class="op">=</span> <span class="bu">abs</span>(rep_row[<span class="st">'value'</span>] <span class="op">-</span> calc_match.iloc[<span class="dv">0</span>][<span class="st">'value'</span>])</span>
<span id="cb3-332"><a href="#cb3-332" aria-hidden="true" tabindex="-1"></a>                        consistency_results.append({</span>
<span id="cb3-333"><a href="#cb3-333" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'offender_type'</span>: offender_type,</span>
<span id="cb3-334"><a href="#cb3-334" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'category'</span>: category,</span>
<span id="cb3-335"><a href="#cb3-335" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'variable'</span>: rep_row[<span class="st">'variable_detailed'</span>],</span>
<span id="cb3-336"><a href="#cb3-336" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'reported'</span>: rep_row[<span class="st">'value'</span>],</span>
<span id="cb3-337"><a href="#cb3-337" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'calculated'</span>: calc_match.iloc[<span class="dv">0</span>][<span class="st">'value'</span>],</span>
<span id="cb3-338"><a href="#cb3-338" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'difference'</span>: diff,</span>
<span id="cb3-339"><a href="#cb3-339" aria-hidden="true" tabindex="-1"></a>                            <span class="st">'consistent'</span>: diff <span class="op">&lt;</span> <span class="fl">0.5</span>  <span class="co"># 0.5% tolerance</span></span>
<span id="cb3-340"><a href="#cb3-340" aria-hidden="true" tabindex="-1"></a>                        })</span>
<span id="cb3-341"><a href="#cb3-341" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-342"><a href="#cb3-342" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> consistency_results:</span>
<span id="cb3-343"><a href="#cb3-343" aria-hidden="true" tabindex="-1"></a>        consistency_df <span class="op">=</span> pd.DataFrame(consistency_results)</span>
<span id="cb3-344"><a href="#cb3-344" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">Percentage consistency check for </span><span class="sc">{</span>state_name<span class="sc">}</span><span class="ss">:"</span>)</span>
<span id="cb3-345"><a href="#cb3-345" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"All values consistent: </span><span class="sc">{</span>consistency_df[<span class="st">'consistent'</span>]<span class="sc">.</span><span class="bu">all</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb3-346"><a href="#cb3-346" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-347"><a href="#cb3-347" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">not</span> consistency_df[<span class="st">'consistent'</span>].<span class="bu">all</span>():</span>
<span id="cb3-348"><a href="#cb3-348" aria-hidden="true" tabindex="-1"></a>            <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Inconsistent values:"</span>)</span>
<span id="cb3-349"><a href="#cb3-349" aria-hidden="true" tabindex="-1"></a>            display(consistency_df[<span class="op">~</span>consistency_df[<span class="st">'consistent'</span>]])</span>
<span id="cb3-350"><a href="#cb3-350" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-351"><a href="#cb3-351" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> consistency_df[<span class="st">'consistent'</span>].<span class="bu">all</span>()</span>
<span id="cb3-352"><a href="#cb3-352" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb3-353"><a href="#cb3-353" aria-hidden="true" tabindex="-1"></a>        <span class="co"># No comparison possible - state only has one type of data</span></span>
<span id="cb3-354"><a href="#cb3-354" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">True</span></span>
<span id="cb3-355"><a href="#cb3-355" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-356"><a href="#cb3-356" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-357"><a href="#cb3-357" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> create_demographic_bar_charts(df_combined, state_name):</span>
<span id="cb3-358"><a href="#cb3-358" aria-hidden="true" tabindex="-1"></a>    <span class="co">"""</span></span>
<span id="cb3-359"><a href="#cb3-359" aria-hidden="true" tabindex="-1"></a><span class="co">    Create clean bar charts showing demographics by offender type.</span></span>
<span id="cb3-360"><a href="#cb3-360" aria-hidden="true" tabindex="-1"></a><span class="co">    Uses counts for exact values and includes percentage labels.</span></span>
<span id="cb3-361"><a href="#cb3-361" aria-hidden="true" tabindex="-1"></a><span class="co">    """</span></span>
<span id="cb3-362"><a href="#cb3-362" aria-hidden="true" tabindex="-1"></a>    state_data <span class="op">=</span> df_combined[df_combined[<span class="st">'state'</span>] <span class="op">==</span> state_name]</span>
<span id="cb3-363"><a href="#cb3-363" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-364"><a href="#cb3-364" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get offender types and ensure Combined is last</span></span>
<span id="cb3-365"><a href="#cb3-365" aria-hidden="true" tabindex="-1"></a>    offender_types <span class="op">=</span> <span class="bu">sorted</span>(state_data[state_data[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'count'</span>][<span class="st">'offender_type'</span>].unique())</span>
<span id="cb3-366"><a href="#cb3-366" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="st">'Combined'</span> <span class="kw">in</span> offender_types:</span>
<span id="cb3-367"><a href="#cb3-367" aria-hidden="true" tabindex="-1"></a>        offender_types.remove(<span class="st">'Combined'</span>)</span>
<span id="cb3-368"><a href="#cb3-368" aria-hidden="true" tabindex="-1"></a>        offender_types.append(<span class="st">'Combined'</span>)</span>
<span id="cb3-369"><a href="#cb3-369" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-370"><a href="#cb3-370" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create figure with side-by-side subplots for gender and race</span></span>
<span id="cb3-371"><a href="#cb3-371" aria-hidden="true" tabindex="-1"></a>    fig, (ax1, ax2) <span class="op">=</span> plt.subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">14</span>, <span class="dv">10</span>))</span>
<span id="cb3-372"><a href="#cb3-372" aria-hidden="true" tabindex="-1"></a>    fig.suptitle(<span class="ss">f'</span><span class="sc">{</span>state_name<span class="sc">}</span><span class="ss"> DNA Database Demographics'</span>, fontsize<span class="op">=</span><span class="dv">20</span>, fontweight<span class="op">=</span><span class="st">'bold'</span>, y<span class="op">=</span><span class="fl">1.01</span>)</span>
<span id="cb3-373"><a href="#cb3-373" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-374"><a href="#cb3-374" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Color palettes - using a modern, visually appealing palette</span></span>
<span id="cb3-375"><a href="#cb3-375" aria-hidden="true" tabindex="-1"></a>    gender_colors <span class="op">=</span> {<span class="st">'Male'</span>: <span class="st">'#4E79A7'</span>, <span class="st">'Female'</span>: <span class="st">'#E15759'</span>}</span>
<span id="cb3-376"><a href="#cb3-376" aria-hidden="true" tabindex="-1"></a>    race_colors <span class="op">=</span> {</span>
<span id="cb3-377"><a href="#cb3-377" aria-hidden="true" tabindex="-1"></a>        <span class="st">'White'</span>: <span class="st">'#4E79A7'</span>,</span>
<span id="cb3-378"><a href="#cb3-378" aria-hidden="true" tabindex="-1"></a>        <span class="st">'African American'</span>: <span class="st">'#F28E2B'</span>, </span>
<span id="cb3-379"><a href="#cb3-379" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Hispanic'</span>: <span class="st">'#E15759'</span>,</span>
<span id="cb3-380"><a href="#cb3-380" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Asian'</span>: <span class="st">'#76B7B2'</span>,</span>
<span id="cb3-381"><a href="#cb3-381" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Native American'</span>: <span class="st">'#59A14F'</span>,</span>
<span id="cb3-382"><a href="#cb3-382" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Unknown'</span>: <span class="st">'#AF7AA1'</span>,</span>
<span id="cb3-383"><a href="#cb3-383" aria-hidden="true" tabindex="-1"></a>        <span class="st">'Other'</span>: <span class="st">'#9C755F'</span></span>
<span id="cb3-384"><a href="#cb3-384" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb3-385"><a href="#cb3-385" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-386"><a href="#cb3-386" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Gender subplot - horizontal bars</span></span>
<span id="cb3-387"><a href="#cb3-387" aria-hidden="true" tabindex="-1"></a>    ax1.set_title(<span class="st">'Gender Distribution'</span>, fontsize<span class="op">=</span><span class="dv">18</span>, pad<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb3-388"><a href="#cb3-388" aria-hidden="true" tabindex="-1"></a>    gender_data <span class="op">=</span> state_data[</span>
<span id="cb3-389"><a href="#cb3-389" aria-hidden="true" tabindex="-1"></a>        (state_data[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'gender'</span>) <span class="op">&amp;</span></span>
<span id="cb3-390"><a href="#cb3-390" aria-hidden="true" tabindex="-1"></a>        (state_data[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'count'</span>)</span>
<span id="cb3-391"><a href="#cb3-391" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb3-392"><a href="#cb3-392" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-393"><a href="#cb3-393" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Prepare data for grouped horizontal bars</span></span>
<span id="cb3-394"><a href="#cb3-394" aria-hidden="true" tabindex="-1"></a>    y_positions <span class="op">=</span> np.arange(<span class="bu">len</span>(offender_types))</span>
<span id="cb3-395"><a href="#cb3-395" aria-hidden="true" tabindex="-1"></a>    bar_height <span class="op">=</span> <span class="fl">0.35</span></span>
<span id="cb3-396"><a href="#cb3-396" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-397"><a href="#cb3-397" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Process each gender</span></span>
<span id="cb3-398"><a href="#cb3-398" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, gender <span class="kw">in</span> <span class="bu">enumerate</span>([<span class="st">'Female'</span>, <span class="st">'Male'</span>]):  <span class="co"># Female first to be on top</span></span>
<span id="cb3-399"><a href="#cb3-399" aria-hidden="true" tabindex="-1"></a>        values <span class="op">=</span> []</span>
<span id="cb3-400"><a href="#cb3-400" aria-hidden="true" tabindex="-1"></a>        percentages <span class="op">=</span> []</span>
<span id="cb3-401"><a href="#cb3-401" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-402"><a href="#cb3-402" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> offender_type <span class="kw">in</span> offender_types:</span>
<span id="cb3-403"><a href="#cb3-403" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get count</span></span>
<span id="cb3-404"><a href="#cb3-404" aria-hidden="true" tabindex="-1"></a>            count_val <span class="op">=</span> gender_data[</span>
<span id="cb3-405"><a href="#cb3-405" aria-hidden="true" tabindex="-1"></a>                (gender_data[<span class="st">'offender_type'</span>] <span class="op">==</span> offender_type) <span class="op">&amp;</span></span>
<span id="cb3-406"><a href="#cb3-406" aria-hidden="true" tabindex="-1"></a>                (gender_data[<span class="st">'variable_detailed'</span>] <span class="op">==</span> gender)</span>
<span id="cb3-407"><a href="#cb3-407" aria-hidden="true" tabindex="-1"></a>            ][<span class="st">'value'</span>].values</span>
<span id="cb3-408"><a href="#cb3-408" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-409"><a href="#cb3-409" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get percentage</span></span>
<span id="cb3-410"><a href="#cb3-410" aria-hidden="true" tabindex="-1"></a>            pct_val <span class="op">=</span> state_data[</span>
<span id="cb3-411"><a href="#cb3-411" aria-hidden="true" tabindex="-1"></a>                (state_data[<span class="st">'offender_type'</span>] <span class="op">==</span> offender_type) <span class="op">&amp;</span></span>
<span id="cb3-412"><a href="#cb3-412" aria-hidden="true" tabindex="-1"></a>                (state_data[<span class="st">'variable_detailed'</span>] <span class="op">==</span> gender) <span class="op">&amp;</span></span>
<span id="cb3-413"><a href="#cb3-413" aria-hidden="true" tabindex="-1"></a>                (state_data[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'gender'</span>) <span class="op">&amp;</span></span>
<span id="cb3-414"><a href="#cb3-414" aria-hidden="true" tabindex="-1"></a>                (state_data[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'percentage'</span>)</span>
<span id="cb3-415"><a href="#cb3-415" aria-hidden="true" tabindex="-1"></a>            ][<span class="st">'value'</span>].values</span>
<span id="cb3-416"><a href="#cb3-416" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-417"><a href="#cb3-417" aria-hidden="true" tabindex="-1"></a>            values.append(count_val[<span class="dv">0</span>] <span class="cf">if</span> <span class="bu">len</span>(count_val) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb3-418"><a href="#cb3-418" aria-hidden="true" tabindex="-1"></a>            percentages.append(pct_val[<span class="dv">0</span>] <span class="cf">if</span> <span class="bu">len</span>(pct_val) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb3-419"><a href="#cb3-419" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-420"><a href="#cb3-420" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot horizontal bars</span></span>
<span id="cb3-421"><a href="#cb3-421" aria-hidden="true" tabindex="-1"></a>        positions <span class="op">=</span> y_positions <span class="op">+</span> bar_height <span class="op">*</span> (i <span class="op">-</span> <span class="fl">0.5</span>)</span>
<span id="cb3-422"><a href="#cb3-422" aria-hidden="true" tabindex="-1"></a>        bars <span class="op">=</span> ax1.barh(positions, values, bar_height, label<span class="op">=</span>gender, </span>
<span id="cb3-423"><a href="#cb3-423" aria-hidden="true" tabindex="-1"></a>                        color<span class="op">=</span>gender_colors.get(gender, <span class="st">'#333333'</span>))</span>
<span id="cb3-424"><a href="#cb3-424" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-425"><a href="#cb3-425" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add count and percentage labels to the right of bars</span></span>
<span id="cb3-426"><a href="#cb3-426" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bar, pct, val <span class="kw">in</span> <span class="bu">zip</span>(bars, percentages, values):</span>
<span id="cb3-427"><a href="#cb3-427" aria-hidden="true" tabindex="-1"></a>            width <span class="op">=</span> bar.get_width()</span>
<span id="cb3-428"><a href="#cb3-428" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> width <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb3-429"><a href="#cb3-429" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Put percentage and count to the right of the bar</span></span>
<span id="cb3-430"><a href="#cb3-430" aria-hidden="true" tabindex="-1"></a>                ax1.text(width, bar.get_y() <span class="op">+</span> bar.get_height()<span class="op">/</span><span class="dv">2</span>,</span>
<span id="cb3-431"><a href="#cb3-431" aria-hidden="true" tabindex="-1"></a>                        <span class="ss">f'  </span><span class="sc">{</span>pct<span class="sc">:.1f}</span><span class="ss">% (</span><span class="sc">{</span><span class="bu">int</span>(val)<span class="sc">:,}</span><span class="ss">)'</span>, ha<span class="op">=</span><span class="st">'left'</span>, va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb3-432"><a href="#cb3-432" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-433"><a href="#cb3-433" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlabel(<span class="st">'Number of Profiles'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb3-434"><a href="#cb3-434" aria-hidden="true" tabindex="-1"></a>    ax1.set_yticks(y_positions)</span>
<span id="cb3-435"><a href="#cb3-435" aria-hidden="true" tabindex="-1"></a>    ax1.set_yticklabels(offender_types, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb3-436"><a href="#cb3-436" aria-hidden="true" tabindex="-1"></a>    ax1.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb3-437"><a href="#cb3-437" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove grid lines and spines for cleaner look</span></span>
<span id="cb3-438"><a href="#cb3-438" aria-hidden="true" tabindex="-1"></a>    ax1.spines[<span class="st">'top'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb3-439"><a href="#cb3-439" aria-hidden="true" tabindex="-1"></a>    ax1.spines[<span class="st">'right'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb3-440"><a href="#cb3-440" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add some padding to x-axis for labels</span></span>
<span id="cb3-441"><a href="#cb3-441" aria-hidden="true" tabindex="-1"></a>    ax1.set_xlim(<span class="dv">0</span>, <span class="bu">max</span>([v <span class="cf">for</span> sublist <span class="kw">in</span> [gender_data[</span>
<span id="cb3-442"><a href="#cb3-442" aria-hidden="true" tabindex="-1"></a>        (gender_data[<span class="st">'offender_type'</span>] <span class="op">==</span> ot) <span class="op">&amp;</span></span>
<span id="cb3-443"><a href="#cb3-443" aria-hidden="true" tabindex="-1"></a>        (gender_data[<span class="st">'variable_detailed'</span>].isin([<span class="st">'Male'</span>, <span class="st">'Female'</span>]))</span>
<span id="cb3-444"><a href="#cb3-444" aria-hidden="true" tabindex="-1"></a>    ][<span class="st">'value'</span>].values <span class="cf">for</span> ot <span class="kw">in</span> offender_types] <span class="cf">for</span> v <span class="kw">in</span> sublist]) <span class="op">*</span> <span class="fl">1.25</span>)</span>
<span id="cb3-445"><a href="#cb3-445" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-446"><a href="#cb3-446" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format x-axis with compact notation (k for thousands, M for millions)</span></span>
<span id="cb3-447"><a href="#cb3-447" aria-hidden="true" tabindex="-1"></a>    ax1.xaxis.set_major_formatter(plt.FuncFormatter(format_compact))</span>
<span id="cb3-448"><a href="#cb3-448" aria-hidden="true" tabindex="-1"></a>    ax1.tick_params(axis<span class="op">=</span><span class="st">'x'</span>, labelsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb3-449"><a href="#cb3-449" aria-hidden="true" tabindex="-1"></a>    ax1.invert_yaxis()  <span class="co"># Invert y-axis to have first offender type at top</span></span>
<span id="cb3-450"><a href="#cb3-450" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-451"><a href="#cb3-451" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Race subplot - horizontal bars</span></span>
<span id="cb3-452"><a href="#cb3-452" aria-hidden="true" tabindex="-1"></a>    ax2.set_title(<span class="st">'Race Distribution'</span>, fontsize<span class="op">=</span><span class="dv">18</span>, pad<span class="op">=</span><span class="dv">15</span>)</span>
<span id="cb3-453"><a href="#cb3-453" aria-hidden="true" tabindex="-1"></a>    race_data <span class="op">=</span> state_data[</span>
<span id="cb3-454"><a href="#cb3-454" aria-hidden="true" tabindex="-1"></a>        (state_data[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'race'</span>) <span class="op">&amp;</span></span>
<span id="cb3-455"><a href="#cb3-455" aria-hidden="true" tabindex="-1"></a>        (state_data[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'count'</span>)</span>
<span id="cb3-456"><a href="#cb3-456" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb3-457"><a href="#cb3-457" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-458"><a href="#cb3-458" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Debug: Check what races we have and their values</span></span>
<span id="cb3-459"><a href="#cb3-459" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> state_name <span class="op">==</span> <span class="st">"California"</span>:</span>
<span id="cb3-460"><a href="#cb3-460" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">DEBUG: Race data for California in visualization:"</span>)</span>
<span id="cb3-461"><a href="#cb3-461" aria-hidden="true" tabindex="-1"></a>        ca_race_debug <span class="op">=</span> state_data[</span>
<span id="cb3-462"><a href="#cb3-462" aria-hidden="true" tabindex="-1"></a>            (state_data[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'race'</span>) <span class="op">&amp;</span> </span>
<span id="cb3-463"><a href="#cb3-463" aria-hidden="true" tabindex="-1"></a>            (state_data[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'Unknown'</span>)</span>
<span id="cb3-464"><a href="#cb3-464" aria-hidden="true" tabindex="-1"></a>        ][[<span class="st">'offender_type'</span>, <span class="st">'value_type'</span>, <span class="st">'value'</span>]]</span>
<span id="cb3-465"><a href="#cb3-465" aria-hidden="true" tabindex="-1"></a>        <span class="bu">print</span>(ca_race_debug)</span>
<span id="cb3-466"><a href="#cb3-466" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-467"><a href="#cb3-467" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get all unique races for this state</span></span>
<span id="cb3-468"><a href="#cb3-468" aria-hidden="true" tabindex="-1"></a>    races <span class="op">=</span> <span class="bu">sorted</span>(race_data[<span class="st">'variable_detailed'</span>].unique())</span>
<span id="cb3-469"><a href="#cb3-469" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-470"><a href="#cb3-470" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Adjust bar height based on number of races</span></span>
<span id="cb3-471"><a href="#cb3-471" aria-hidden="true" tabindex="-1"></a>    race_height <span class="op">=</span> <span class="bu">min</span>(<span class="fl">0.8</span> <span class="op">/</span> <span class="bu">len</span>(races), <span class="fl">0.15</span>)  <span class="co"># Cap at 0.15 to prevent too thick bars</span></span>
<span id="cb3-472"><a href="#cb3-472" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-473"><a href="#cb3-473" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create race positions for grouping</span></span>
<span id="cb3-474"><a href="#cb3-474" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i, race <span class="kw">in</span> <span class="bu">enumerate</span>(races):</span>
<span id="cb3-475"><a href="#cb3-475" aria-hidden="true" tabindex="-1"></a>        values <span class="op">=</span> []</span>
<span id="cb3-476"><a href="#cb3-476" aria-hidden="true" tabindex="-1"></a>        percentages <span class="op">=</span> []</span>
<span id="cb3-477"><a href="#cb3-477" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-478"><a href="#cb3-478" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> offender_type <span class="kw">in</span> offender_types:</span>
<span id="cb3-479"><a href="#cb3-479" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get count</span></span>
<span id="cb3-480"><a href="#cb3-480" aria-hidden="true" tabindex="-1"></a>            count_val <span class="op">=</span> race_data[</span>
<span id="cb3-481"><a href="#cb3-481" aria-hidden="true" tabindex="-1"></a>                (race_data[<span class="st">'offender_type'</span>] <span class="op">==</span> offender_type) <span class="op">&amp;</span></span>
<span id="cb3-482"><a href="#cb3-482" aria-hidden="true" tabindex="-1"></a>                (race_data[<span class="st">'variable_detailed'</span>] <span class="op">==</span> race)</span>
<span id="cb3-483"><a href="#cb3-483" aria-hidden="true" tabindex="-1"></a>            ][<span class="st">'value'</span>].values</span>
<span id="cb3-484"><a href="#cb3-484" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-485"><a href="#cb3-485" aria-hidden="true" tabindex="-1"></a>            <span class="co"># Get percentage</span></span>
<span id="cb3-486"><a href="#cb3-486" aria-hidden="true" tabindex="-1"></a>            pct_val <span class="op">=</span> state_data[</span>
<span id="cb3-487"><a href="#cb3-487" aria-hidden="true" tabindex="-1"></a>                (state_data[<span class="st">'offender_type'</span>] <span class="op">==</span> offender_type) <span class="op">&amp;</span></span>
<span id="cb3-488"><a href="#cb3-488" aria-hidden="true" tabindex="-1"></a>                (state_data[<span class="st">'variable_detailed'</span>] <span class="op">==</span> race) <span class="op">&amp;</span></span>
<span id="cb3-489"><a href="#cb3-489" aria-hidden="true" tabindex="-1"></a>                (state_data[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'race'</span>) <span class="op">&amp;</span></span>
<span id="cb3-490"><a href="#cb3-490" aria-hidden="true" tabindex="-1"></a>                (state_data[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'percentage'</span>)</span>
<span id="cb3-491"><a href="#cb3-491" aria-hidden="true" tabindex="-1"></a>            ][<span class="st">'value'</span>].values</span>
<span id="cb3-492"><a href="#cb3-492" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb3-493"><a href="#cb3-493" aria-hidden="true" tabindex="-1"></a>            values.append(count_val[<span class="dv">0</span>] <span class="cf">if</span> <span class="bu">len</span>(count_val) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb3-494"><a href="#cb3-494" aria-hidden="true" tabindex="-1"></a>            percentages.append(pct_val[<span class="dv">0</span>] <span class="cf">if</span> <span class="bu">len</span>(pct_val) <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span>)</span>
<span id="cb3-495"><a href="#cb3-495" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-496"><a href="#cb3-496" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot horizontal bars</span></span>
<span id="cb3-497"><a href="#cb3-497" aria-hidden="true" tabindex="-1"></a>        positions <span class="op">=</span> y_positions <span class="op">+</span> race_height <span class="op">*</span> (i <span class="op">-</span> <span class="bu">len</span>(races)<span class="op">/</span><span class="dv">2</span> <span class="op">+</span> <span class="fl">0.5</span>)</span>
<span id="cb3-498"><a href="#cb3-498" aria-hidden="true" tabindex="-1"></a>        bars <span class="op">=</span> ax2.barh(positions, values, race_height, label<span class="op">=</span>race,</span>
<span id="cb3-499"><a href="#cb3-499" aria-hidden="true" tabindex="-1"></a>                        color<span class="op">=</span>race_colors.get(race, <span class="st">'#333333'</span>))</span>
<span id="cb3-500"><a href="#cb3-500" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb3-501"><a href="#cb3-501" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Add count and percentage labels to the right of bars</span></span>
<span id="cb3-502"><a href="#cb3-502" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> bar, pct, val <span class="kw">in</span> <span class="bu">zip</span>(bars, percentages, values):</span>
<span id="cb3-503"><a href="#cb3-503" aria-hidden="true" tabindex="-1"></a>            width <span class="op">=</span> bar.get_width()</span>
<span id="cb3-504"><a href="#cb3-504" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> width <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb3-505"><a href="#cb3-505" aria-hidden="true" tabindex="-1"></a>                <span class="co"># Put percentage and count to the right of the bar</span></span>
<span id="cb3-506"><a href="#cb3-506" aria-hidden="true" tabindex="-1"></a>                ax2.text(width, bar.get_y() <span class="op">+</span> bar.get_height()<span class="op">/</span><span class="dv">2</span>,</span>
<span id="cb3-507"><a href="#cb3-507" aria-hidden="true" tabindex="-1"></a>                        <span class="ss">f'  </span><span class="sc">{</span>pct<span class="sc">:.1f}</span><span class="ss">% (</span><span class="sc">{</span><span class="bu">int</span>(val)<span class="sc">:,}</span><span class="ss">)'</span>, ha<span class="op">=</span><span class="st">'left'</span>, va<span class="op">=</span><span class="st">'center'</span>, fontsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb3-508"><a href="#cb3-508" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-509"><a href="#cb3-509" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlabel(<span class="st">'Number of Profiles'</span>, fontsize<span class="op">=</span><span class="dv">16</span>)</span>
<span id="cb3-510"><a href="#cb3-510" aria-hidden="true" tabindex="-1"></a>    ax2.set_yticks(y_positions)</span>
<span id="cb3-511"><a href="#cb3-511" aria-hidden="true" tabindex="-1"></a>    ax2.set_yticklabels(offender_types, fontsize<span class="op">=</span><span class="dv">14</span>)</span>
<span id="cb3-512"><a href="#cb3-512" aria-hidden="true" tabindex="-1"></a>    ax2.legend(loc<span class="op">=</span><span class="st">'upper right'</span>, ncol<span class="op">=</span><span class="dv">1</span>, fontsize<span class="op">=</span><span class="dv">11</span>)</span>
<span id="cb3-513"><a href="#cb3-513" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Remove grid lines and spines for cleaner look</span></span>
<span id="cb3-514"><a href="#cb3-514" aria-hidden="true" tabindex="-1"></a>    ax2.spines[<span class="st">'top'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb3-515"><a href="#cb3-515" aria-hidden="true" tabindex="-1"></a>    ax2.spines[<span class="st">'right'</span>].set_visible(<span class="va">False</span>)</span>
<span id="cb3-516"><a href="#cb3-516" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add some padding to x-axis for labels</span></span>
<span id="cb3-517"><a href="#cb3-517" aria-hidden="true" tabindex="-1"></a>    ax2.set_xlim(<span class="dv">0</span>, <span class="bu">max</span>([v <span class="cf">for</span> sublist <span class="kw">in</span> [race_data[</span>
<span id="cb3-518"><a href="#cb3-518" aria-hidden="true" tabindex="-1"></a>        race_data[<span class="st">'offender_type'</span>] <span class="op">==</span> ot</span>
<span id="cb3-519"><a href="#cb3-519" aria-hidden="true" tabindex="-1"></a>    ][<span class="st">'value'</span>].values <span class="cf">for</span> ot <span class="kw">in</span> offender_types] <span class="cf">for</span> v <span class="kw">in</span> sublist <span class="cf">if</span> v <span class="op">&gt;</span> <span class="dv">0</span>]) <span class="op">*</span> <span class="fl">1.25</span>)</span>
<span id="cb3-520"><a href="#cb3-520" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-521"><a href="#cb3-521" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Format x-axis with compact notation (k for thousands, M for millions)</span></span>
<span id="cb3-522"><a href="#cb3-522" aria-hidden="true" tabindex="-1"></a>    ax2.xaxis.set_major_formatter(plt.FuncFormatter(format_compact))</span>
<span id="cb3-523"><a href="#cb3-523" aria-hidden="true" tabindex="-1"></a>    ax2.tick_params(axis<span class="op">=</span><span class="st">'x'</span>, labelsize<span class="op">=</span><span class="dv">12</span>)</span>
<span id="cb3-524"><a href="#cb3-524" aria-hidden="true" tabindex="-1"></a>    ax2.invert_yaxis()  <span class="co"># Invert y-axis to have first offender type at top</span></span>
<span id="cb3-525"><a href="#cb3-525" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-526"><a href="#cb3-526" aria-hidden="true" tabindex="-1"></a>    plt.tight_layout()</span>
<span id="cb3-527"><a href="#cb3-527" aria-hidden="true" tabindex="-1"></a>    plt.show()</span>
<span id="cb3-528"><a href="#cb3-528" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-529"><a href="#cb3-529" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Also display a summary table with totals</span></span>
<span id="cb3-530"><a href="#cb3-530" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="sc">{</span>state_name<span class="sc">}</span><span class="ss"> profile totals by offender type:"</span>)</span>
<span id="cb3-531"><a href="#cb3-531" aria-hidden="true" tabindex="-1"></a>    totals_data <span class="op">=</span> state_data[</span>
<span id="cb3-532"><a href="#cb3-532" aria-hidden="true" tabindex="-1"></a>        (state_data[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'total'</span>) <span class="op">&amp;</span></span>
<span id="cb3-533"><a href="#cb3-533" aria-hidden="true" tabindex="-1"></a>        (state_data[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'total_profiles'</span>) <span class="op">&amp;</span></span>
<span id="cb3-534"><a href="#cb3-534" aria-hidden="true" tabindex="-1"></a>        (state_data[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'count'</span>)</span>
<span id="cb3-535"><a href="#cb3-535" aria-hidden="true" tabindex="-1"></a>    ][[<span class="st">'offender_type'</span>, <span class="st">'value'</span>]].copy()</span>
<span id="cb3-536"><a href="#cb3-536" aria-hidden="true" tabindex="-1"></a>    totals_data[<span class="st">'value'</span>] <span class="op">=</span> totals_data[<span class="st">'value'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="ss">f"</span><span class="sc">{</span><span class="bu">int</span>(x)<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb3-537"><a href="#cb3-537" aria-hidden="true" tabindex="-1"></a>    totals_data.columns <span class="op">=</span> [<span class="st">'Offender Type'</span>, <span class="st">'Total Profiles'</span>]</span>
<span id="cb3-538"><a href="#cb3-538" aria-hidden="true" tabindex="-1"></a>    display(totals_data.set_index(<span class="st">'Offender Type'</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="analyses" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Analyses</h1>
<section id="california" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="california"><span class="header-section-number">3.1</span> California</h2>
<div id="cell-ca-load-preview" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>ca_path <span class="op">=</span> per_state <span class="op">/</span> <span class="st">"california_foia_data.csv"</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>ca      <span class="op">=</span> pd.read_csv(ca_path)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>display(ca)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="ca-load-preview" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">variable_detailed</th>
<th data-quarto-table-cell-role="th">value</th>
<th data-quarto-table-cell-role="th">value_type</th>
<th data-quarto-table-cell-role="th">date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>California</td>
<td>Convicted Offender</td>
<td>total</td>
<td>total_profiles</td>
<td>2019899</td>
<td>count</td>
<td>2018-07-05</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>California</td>
<td>Arrestee</td>
<td>total</td>
<td>total_profiles</td>
<td>751822</td>
<td>count</td>
<td>2018-07-05</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>California</td>
<td>Convicted Offender</td>
<td>gender</td>
<td>Female</td>
<td>309827</td>
<td>count</td>
<td>2018-07-05</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>California</td>
<td>Convicted Offender</td>
<td>gender</td>
<td>Male</td>
<td>1603222</td>
<td>count</td>
<td>2018-07-05</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>California</td>
<td>Convicted Offender</td>
<td>gender</td>
<td>Unknown</td>
<td>106850</td>
<td>count</td>
<td>2018-07-05</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>California</td>
<td>Arrestee</td>
<td>gender</td>
<td>Female</td>
<td>208225</td>
<td>count</td>
<td>2018-07-05</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>California</td>
<td>Arrestee</td>
<td>gender</td>
<td>Male</td>
<td>524231</td>
<td>count</td>
<td>2018-07-05</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>California</td>
<td>Arrestee</td>
<td>gender</td>
<td>Unknown</td>
<td>19366</td>
<td>count</td>
<td>2018-07-05</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>California</td>
<td>Convicted Offender</td>
<td>race</td>
<td>African American</td>
<td>368952</td>
<td>count</td>
<td>2018-07-05</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>California</td>
<td>Convicted Offender</td>
<td>race</td>
<td>Caucasian</td>
<td>588555</td>
<td>count</td>
<td>2018-07-05</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>California</td>
<td>Convicted Offender</td>
<td>race</td>
<td>Hispanic</td>
<td>652121</td>
<td>count</td>
<td>2018-07-05</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>California</td>
<td>Convicted Offender</td>
<td>race</td>
<td>Asian</td>
<td>16384</td>
<td>count</td>
<td>2018-07-05</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>California</td>
<td>Arrestee</td>
<td>race</td>
<td>African American</td>
<td>104741</td>
<td>count</td>
<td>2018-07-05</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>California</td>
<td>Arrestee</td>
<td>race</td>
<td>Caucasian</td>
<td>231313</td>
<td>count</td>
<td>2018-07-05</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>California</td>
<td>Arrestee</td>
<td>race</td>
<td>Hispanic</td>
<td>308450</td>
<td>count</td>
<td>2018-07-05</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>California</td>
<td>Arrestee</td>
<td>race</td>
<td>Asian</td>
<td>11191</td>
<td>count</td>
<td>2018-07-05</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>We begin by loading California’s file. California supplies <strong>counts only</strong> for gender and race plus a separate total for each offender type; no percentages are reported.</p>
<p>Recording California’s reporting structure:</p>
<div id="ca-add-metadata" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>foia_state_metadata.append({</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"state"</span>: <span class="st">"California"</span>,</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"race_report_values"</span>:   report_status(ca, <span class="st">"race"</span>),</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gender_report_values"</span>: report_status(ca, <span class="st">"gender"</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ Added metadata row:"</span>, foia_state_metadata[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Added metadata row: {'state': 'California', 'race_report_values': 'counts', 'gender_report_values': 'counts'}</code></pre>
</div>
</div>
<section id="verifying-that-demographic-counts-match-reported-totals" class="level3" data-number="3.1.1">
<h3 data-number="3.1.1" class="anchored" data-anchor-id="verifying-that-demographic-counts-match-reported-totals"><span class="header-section-number">3.1.1</span> Verifying that demographic counts match reported totals</h3>
<p>Using the <code>verify_category_totals</code> helper function:</p>
<div id="cell-ca-run-category-verify" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>ca_category_qc <span class="op">=</span> verify_category_totals(ca)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>ca_category_qc</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="ca-run-category-verify" class="cell-output cell-output-display" data-execution_count="5">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">total_profiles</th>
<th data-quarto-table-cell-role="th">sum_demo_counts</th>
<th data-quarto-table-cell-role="th">difference</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Arrestee</td>
<td>gender</td>
<td>751822</td>
<td>751822</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Arrestee</td>
<td>race</td>
<td>751822</td>
<td>655695</td>
<td>96127</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Convicted Offender</td>
<td>gender</td>
<td>2019899</td>
<td>2019899</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Convicted Offender</td>
<td>race</td>
<td>2019899</td>
<td>1626012</td>
<td>393887</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="interpreting-the-race-shortfall" class="level3" data-number="3.1.2">
<h3 data-number="3.1.2" class="anchored" data-anchor-id="interpreting-the-race-shortfall"><span class="header-section-number">3.1.2</span> Interpreting the race shortfall</h3>
<blockquote class="blockquote">
<p><em>“Racial classification is not considered a required field on the collection card; thus, an unknown number of offenders may have <strong>no racial classification listed</strong>.”</em> — California DOJ FOIA letter, July 10 2018 (<code>raw/foia_pdfs/FOIA_RacialComp_California.pdf</code>)</p>
</blockquote>
<p>The 393 887 Convicted‑Offender profiles and 96 127 Arrestee profiles that do <strong>not</strong> appear in any of the four reported race categories must therefore belong to an unreported “Unknown/Other” bucket. To keep row totals consistent and enable percentage calculations later, we add one new race row per offender type:</p>
<ul>
<li><code>variable_category = "race"</code></li>
<li><code>variable_detailed = "Unknown"</code></li>
<li><code>value_type = "count"</code></li>
<li><code>value_source = "calculated"</code></li>
</ul>
<div id="cell-ca-insert-unknown" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 1.  Remove any prior Unknown‑race rows </span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>ca <span class="op">=</span> ca[<span class="op">~</span>(</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    (ca[<span class="st">"variable_category"</span>] <span class="op">==</span> <span class="st">"race"</span>) <span class="op">&amp;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    (ca[<span class="st">"variable_detailed"</span>] <span class="op">==</span> <span class="st">"Unknown"</span>)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>)].copy()</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="co"># 2.  Add one Unknown‑race row per offender type</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>unknown_rows <span class="op">=</span> pd.DataFrame([</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">"state"</span>: <span class="st">"California"</span>,</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="st">"offender_type"</span>: <span class="st">"Convicted Offender"</span>,</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="st">"variable_category"</span>: <span class="st">"race"</span>,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>        <span class="st">"variable_detailed"</span>: <span class="st">"Unknown"</span>,</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">"value"</span>: <span class="dv">393887</span>,           </span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>        <span class="st">"value_type"</span>: <span class="st">"count"</span>,</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        <span class="st">"value_source"</span>: <span class="st">"calculated"</span>,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    {</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        <span class="st">"state"</span>: <span class="st">"California"</span>,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="st">"offender_type"</span>: <span class="st">"Arrestee"</span>,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">"variable_category"</span>: <span class="st">"race"</span>,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        <span class="st">"variable_detailed"</span>: <span class="st">"Unknown"</span>,</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        <span class="st">"value"</span>: <span class="dv">96127</span>,</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        <span class="st">"value_type"</span>: <span class="st">"count"</span>,</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>        <span class="st">"value_source"</span>: <span class="st">"calculated"</span>,</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>])</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>ca <span class="op">=</span> pd.concat([ca, unknown_rows], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 3.  Confirm race and gender now reconcile to totals</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Category‑level check after adding Unknown rows:"</span>)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>display(verify_category_totals(ca))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Category‑level check after adding Unknown rows:</code></pre>
</div>
<div id="ca-insert-unknown" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">total_profiles</th>
<th data-quarto-table-cell-role="th">sum_demo_counts</th>
<th data-quarto-table-cell-role="th">difference</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Arrestee</td>
<td>gender</td>
<td>751822</td>
<td>751822</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Arrestee</td>
<td>race</td>
<td>751822</td>
<td>751822</td>
<td>0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Convicted Offender</td>
<td>gender</td>
<td>2019899</td>
<td>2019899</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Convicted Offender</td>
<td>race</td>
<td>2019899</td>
<td>2019899</td>
<td>0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="creating-combined-totals" class="level3" data-number="3.1.3">
<h3 data-number="3.1.3" class="anchored" data-anchor-id="creating-combined-totals"><span class="header-section-number">3.1.3</span> Creating Combined totals</h3>
<p>California reported data separately for Convicted Offenders and Arrestees. Combined totals are calculated by summing across both offender types for all categories and demographic values.</p>
<div id="ca-create-combined" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Combined totals using helper function</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>combined_df <span class="op">=</span> calculate_combined_totals(ca, <span class="st">"California"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add Combined rows to ca</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>ca <span class="op">=</span> pd.concat([ca, combined_df], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ Created Combined totals for California"</span>)</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Combined total profiles: </span><span class="sc">{</span>combined_df[combined_df[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'total_profiles'</span>][<span class="st">'value'</span>]<span class="sc">.</span>values[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Display Combined gender counts</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Combined gender counts:"</span>)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>display(combined_df[combined_df[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'gender'</span>].sort_values(<span class="st">'variable_detailed'</span>))</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Display Combined race counts  </span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Combined race counts:"</span>)</span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>display(combined_df[combined_df[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'race'</span>].sort_values(<span class="st">'variable_detailed'</span>))</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify Combined calculations</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">✓ Verification of Combined calculations:"</span>)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Get counts dataframe for verification</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>counts_df <span class="op">=</span> ca[(ca[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'count'</span>) <span class="op">&amp;</span> (ca[<span class="st">'offender_type'</span>] <span class="op">!=</span> <span class="st">'Combined'</span>)].copy()</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>conv_total <span class="op">=</span> counts_df[(counts_df[<span class="st">'offender_type'</span>] <span class="op">==</span> <span class="st">'Convicted Offender'</span>) <span class="op">&amp;</span> </span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>                       (counts_df[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'total_profiles'</span>)][<span class="st">'value'</span>].values[<span class="dv">0</span>]</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>arr_total <span class="op">=</span> counts_df[(counts_df[<span class="st">'offender_type'</span>] <span class="op">==</span> <span class="st">'Arrestee'</span>) <span class="op">&amp;</span> </span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>                      (counts_df[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'total_profiles'</span>)][<span class="st">'value'</span>].values[<span class="dv">0</span>]</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>comb_total <span class="op">=</span> combined_df[combined_df[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'total_profiles'</span>][<span class="st">'value'</span>].values[<span class="dv">0</span>]</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Convicted Offender total: </span><span class="sc">{</span>conv_total<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Arrestee total: </span><span class="sc">{</span>arr_total<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Sum: </span><span class="sc">{</span>conv_total <span class="op">+</span> arr_total<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Combined total: </span><span class="sc">{</span>comb_total<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Match: </span><span class="sc">{</span>conv_total <span class="op">+</span> arr_total <span class="op">==</span> comb_total<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Created Combined totals for California
  Combined total profiles: 2,771,721

Combined gender counts:</code></pre>
</div>
<div id="ca-create-combined-1" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">variable_detailed</th>
<th data-quarto-table-cell-role="th">value</th>
<th data-quarto-table-cell-role="th">value_type</th>
<th data-quarto-table-cell-role="th">value_source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>California</td>
<td>Combined</td>
<td>gender</td>
<td>Female</td>
<td>518052</td>
<td>count</td>
<td>calculated</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>California</td>
<td>Combined</td>
<td>gender</td>
<td>Male</td>
<td>2127453</td>
<td>count</td>
<td>calculated</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>California</td>
<td>Combined</td>
<td>gender</td>
<td>Unknown</td>
<td>126216</td>
<td>count</td>
<td>calculated</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Combined race counts:</code></pre>
</div>
<div id="ca-create-combined-2" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">variable_detailed</th>
<th data-quarto-table-cell-role="th">value</th>
<th data-quarto-table-cell-role="th">value_type</th>
<th data-quarto-table-cell-role="th">value_source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>California</td>
<td>Combined</td>
<td>race</td>
<td>African American</td>
<td>473693</td>
<td>count</td>
<td>calculated</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>California</td>
<td>Combined</td>
<td>race</td>
<td>Asian</td>
<td>27575</td>
<td>count</td>
<td>calculated</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>California</td>
<td>Combined</td>
<td>race</td>
<td>Caucasian</td>
<td>819868</td>
<td>count</td>
<td>calculated</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>California</td>
<td>Combined</td>
<td>race</td>
<td>Hispanic</td>
<td>960571</td>
<td>count</td>
<td>calculated</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">7</td>
<td>California</td>
<td>Combined</td>
<td>race</td>
<td>Unknown</td>
<td>490014</td>
<td>count</td>
<td>calculated</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
✓ Verification of Combined calculations:
  Convicted Offender total: 2,019,899
  Arrestee total: 751,822
  Sum: 2,771,721
  Combined total: 2,771,721
  Match: True</code></pre>
</div>
</div>
</section>
<section id="preparing-california-data-for-the-combined-dataset" class="level3" data-number="3.1.4">
<h3 data-number="3.1.4" class="anchored" data-anchor-id="preparing-california-data-for-the-combined-dataset"><span class="header-section-number">3.1.4</span> Preparing California data for the combined dataset</h3>
<p>The California data requires selection of specific columns for inclusion in the combined dataset.</p>
<div id="ca-append-to-combined" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Create California data for foia_combined with only needed columns</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="co"># ------------------------------------------------------------------</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Select existing California data with the columns we want</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>ca_for_combined <span class="op">=</span> ca[[<span class="st">'state'</span>, <span class="st">'offender_type'</span>, <span class="st">'variable_category'</span>, </span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>                      <span class="st">'variable_detailed'</span>, <span class="st">'value'</span>, <span class="st">'value_type'</span>]].copy()</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Add value_source column</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>ca_for_combined[<span class="st">'value_source'</span>] <span class="op">=</span> <span class="st">'reported'</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Update value_source for calculated rows (Unknown race and Combined totals)</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>ca_for_combined.loc[</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    ((ca_for_combined[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'race'</span>) <span class="op">&amp;</span> </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>     (ca_for_combined[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'Unknown'</span>)) <span class="op">|</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>    (ca_for_combined[<span class="st">'offender_type'</span>] <span class="op">==</span> <span class="st">'Combined'</span>), </span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'value_source'</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a>] <span class="op">=</span> <span class="st">'calculated'</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Display sample of data structure</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"California data structure verification:"</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique offender types: </span><span class="sc">{</span>ca_for_combined[<span class="st">'offender_type'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique variable categories: </span><span class="sc">{</span>ca_for_combined[<span class="st">'variable_category'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Append to the combined dataframe</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>foia_combined <span class="op">=</span> pd.concat([foia_combined, ca_for_combined], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✓ Appended </span><span class="sc">{</span><span class="bu">len</span>(ca_for_combined)<span class="sc">}</span><span class="ss"> California rows to foia_combined"</span>)</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Total rows in foia_combined: </span><span class="sc">{</span><span class="bu">len</span>(foia_combined)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>California data structure verification:
Unique offender types: ['Convicted Offender' 'Arrestee' 'Combined']
Unique variable categories: ['total' 'gender' 'race']

✓ Appended 27 California rows to foia_combined
✓ Total rows in foia_combined: 27</code></pre>
</div>
</div>
</section>
<section id="calculating-percentages" class="level3" data-number="3.1.5">
<h3 data-number="3.1.5" class="anchored" data-anchor-id="calculating-percentages"><span class="header-section-number">3.1.5</span> Calculating percentages</h3>
<p>California provided only counts. For comparative analysis, percentages are calculated for each demographic category as the proportion of each demographic value relative to the total profiles for that offender type.</p>
<div id="ca-calculate-percentages" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate percentages using helper function</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>percentages_df <span class="op">=</span> calculate_percentages(foia_combined, <span class="st">"California"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add percentages to foia_combined</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>foia_combined <span class="op">=</span> pd.concat([foia_combined, percentages_df], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Calculated and added </span><span class="sc">{</span><span class="bu">len</span>(percentages_df)<span class="sc">}</span><span class="ss"> percentage rows for California"</span>)</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Total rows in foia_combined: </span><span class="sc">{</span><span class="bu">len</span>(foia_combined)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the actual percentage values</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Gender percentages by offender type:"</span>)</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>gender_pct <span class="op">=</span> percentages_df[percentages_df[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'gender'</span>].pivot_table(</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">'variable_detailed'</span>, columns<span class="op">=</span><span class="st">'offender_type'</span>, values<span class="op">=</span><span class="st">'value'</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>display(gender_pct)</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Race percentages by offender type:"</span>)</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a>race_pct <span class="op">=</span> percentages_df[percentages_df[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'race'</span>].pivot_table(</span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">'variable_detailed'</span>, columns<span class="op">=</span><span class="st">'offender_type'</span>, values<span class="op">=</span><span class="st">'value'</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>display(race_pct)</span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify percentages sum to approximately 100% for each category</span></span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Verification of percentage totals by category:"</span>)</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>verification <span class="op">=</span> (percentages_df.groupby([<span class="st">'offender_type'</span>, <span class="st">'variable_category'</span>])[<span class="st">'value'</span>]</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>                .<span class="bu">sum</span>()</span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>                .<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>                .reset_index()</span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>                .rename(columns<span class="op">=</span>{<span class="st">'value'</span>: <span class="st">'sum_of_percentages'</span>}))</span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>display(verification)</span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a><span class="co"># Note about rounding</span></span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Note: Percentage sums may not equal exactly 100</span><span class="sc">% d</span><span class="st">ue to rounding to 2 decimal places."</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Calculated and added 24 percentage rows for California
✓ Total rows in foia_combined: 51

Gender percentages by offender type:</code></pre>
</div>
<div id="ca-calculate-percentages-1" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">Arrestee</th>
<th data-quarto-table-cell-role="th">Combined</th>
<th data-quarto-table-cell-role="th">Convicted Offender</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">variable_detailed</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Female</td>
<td>27.70</td>
<td>18.69</td>
<td>15.34</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Male</td>
<td>69.73</td>
<td>76.76</td>
<td>79.37</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Unknown</td>
<td>2.58</td>
<td>4.55</td>
<td>5.29</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Race percentages by offender type:</code></pre>
</div>
<div id="ca-calculate-percentages-2" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">Arrestee</th>
<th data-quarto-table-cell-role="th">Combined</th>
<th data-quarto-table-cell-role="th">Convicted Offender</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">variable_detailed</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">African American</td>
<td>13.93</td>
<td>17.09</td>
<td>18.27</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Asian</td>
<td>1.49</td>
<td>0.99</td>
<td>0.81</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Caucasian</td>
<td>30.77</td>
<td>29.58</td>
<td>29.14</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Hispanic</td>
<td>41.03</td>
<td>34.66</td>
<td>32.28</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Unknown</td>
<td>12.79</td>
<td>17.68</td>
<td>19.50</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Verification of percentage totals by category:</code></pre>
</div>
<div id="ca-calculate-percentages-3" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">sum_of_percentages</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Arrestee</td>
<td>gender</td>
<td>100.01</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Arrestee</td>
<td>race</td>
<td>100.01</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Combined</td>
<td>gender</td>
<td>100.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Combined</td>
<td>race</td>
<td>100.00</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Convicted Offender</td>
<td>gender</td>
<td>100.00</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Convicted Offender</td>
<td>race</td>
<td>100.00</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Note: Percentage sums may not equal exactly 100% due to rounding to 2 decimal places.</code></pre>
</div>
</div>
</section>
<section id="visualizing-california-demographics" class="level3" data-number="3.1.6">
<h3 data-number="3.1.6" class="anchored" data-anchor-id="visualizing-california-demographics"><span class="header-section-number">3.1.6</span> Visualizing California demographics</h3>
<div id="ca-visualize" class="cell" data-fig-height="12" data-fig-width="18" data-execution_count="10">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Debug: Check what percentages are in the data for Unknown race</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>ca_data <span class="op">=</span> foia_combined[foia_combined[<span class="st">'state'</span>] <span class="op">==</span> <span class="st">'California'</span>]</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>unknown_pcts <span class="op">=</span> ca_data[</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>    (ca_data[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'Unknown'</span>) <span class="op">&amp;</span> </span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>    (ca_data[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'percentage'</span>)</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>][[<span class="st">'offender_type'</span>, <span class="st">'value'</span>]]</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Unknown race percentages in California data:"</span>)</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>display(unknown_pcts)</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Create cleaner bar chart visualization</span></span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a>create_demographic_bar_charts(foia_combined, <span class="st">"California"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unknown race percentages in California data:</code></pre>
</div>
<div id="ca-visualize-1" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">value</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">29</td>
<td>Convicted Offender</td>
<td>5.29</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">34</td>
<td>Convicted Offender</td>
<td>19.50</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">37</td>
<td>Arrestee</td>
<td>2.58</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">42</td>
<td>Arrestee</td>
<td>12.79</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">45</td>
<td>Combined</td>
<td>4.55</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50</td>
<td>Combined</td>
<td>17.68</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
DEBUG: Race data for California in visualization:
         offender_type  value_type      value
16  Convicted Offender       count  393887.00
17            Arrestee       count   96127.00
25            Combined       count  490014.00
34  Convicted Offender  percentage      19.50
42            Arrestee  percentage      12.79
50            Combined  percentage      17.68</code></pre>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="foia_processing_files/figure-html/ca-visualize-output-4.png" id="ca-visualize-2" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
California profile totals by offender type:</code></pre>
</div>
<div id="ca-visualize-3" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Total Profiles</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Offender Type</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Convicted Offender</td>
<td>2,019,899</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Arrestee</td>
<td>751,822</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Combined</td>
<td>2,771,721</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="summary-of-california-processing" class="level3" data-number="3.1.7">
<h3 data-number="3.1.7" class="anchored" data-anchor-id="summary-of-california-processing"><span class="header-section-number">3.1.7</span> Summary of California processing</h3>
<p>California data processing complete. The dataset now includes:</p>
<ul>
<li>Reported counts for Convicted Offenders and Arrestees</li>
<li>Calculated Unknown race counts to reconcile reported totals</li>
<li>Calculated Combined totals for gender and race categories</li>
<li>Calculated percentages for all offender types and demographic categories</li>
</ul>
<p>All values include appropriate <code>value_source</code> indicators distinguishing reported from calculated values.</p>
</section>
</section>
<section id="florida" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="florida"><span class="header-section-number">3.2</span> Florida</h2>
<div id="cell-fl-load-preview" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>fl_path <span class="op">=</span> per_state <span class="op">/</span> <span class="st">"florida_foia_data.csv"</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>fl <span class="op">=</span> pd.read_csv(fl_path)</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>display(fl)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fl-load-preview" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">variable_detailed</th>
<th data-quarto-table-cell-role="th">value</th>
<th data-quarto-table-cell-role="th">value_type</th>
<th data-quarto-table-cell-role="th">date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Florida</td>
<td>Combined</td>
<td>total</td>
<td>total_profiles</td>
<td>1175391.00</td>
<td>count</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Florida</td>
<td>Combined</td>
<td>total</td>
<td>total_profiles</td>
<td>100.00</td>
<td>percentage</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Florida</td>
<td>Combined</td>
<td>gender</td>
<td>Female</td>
<td>260885.00</td>
<td>count</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Florida</td>
<td>Combined</td>
<td>gender</td>
<td>Female</td>
<td>22.20</td>
<td>percentage</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Florida</td>
<td>Combined</td>
<td>gender</td>
<td>Male</td>
<td>901126.00</td>
<td>count</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Florida</td>
<td>Combined</td>
<td>gender</td>
<td>Male</td>
<td>76.67</td>
<td>percentage</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Florida</td>
<td>Combined</td>
<td>gender</td>
<td>Unknown</td>
<td>13380.00</td>
<td>count</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Florida</td>
<td>Combined</td>
<td>gender</td>
<td>Unknown</td>
<td>1.14</td>
<td>percentage</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Florida</td>
<td>Combined</td>
<td>race</td>
<td>African American</td>
<td>413733.00</td>
<td>count</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>Florida</td>
<td>Combined</td>
<td>race</td>
<td>African American</td>
<td>35.20</td>
<td>percentage</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Florida</td>
<td>Combined</td>
<td>race</td>
<td>Asian</td>
<td>2659.00</td>
<td>count</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>Florida</td>
<td>Combined</td>
<td>race</td>
<td>Asian</td>
<td>0.23</td>
<td>percentage</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>Florida</td>
<td>Combined</td>
<td>race</td>
<td>Caucasian</td>
<td>721485.00</td>
<td>count</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>Florida</td>
<td>Combined</td>
<td>race</td>
<td>Caucasian</td>
<td>61.38</td>
<td>percentage</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>Florida</td>
<td>Combined</td>
<td>race</td>
<td>Hispanic</td>
<td>28452.00</td>
<td>count</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>Florida</td>
<td>Combined</td>
<td>race</td>
<td>Hispanic</td>
<td>2.42</td>
<td>percentage</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>Florida</td>
<td>Combined</td>
<td>race</td>
<td>Native American</td>
<td>667.00</td>
<td>count</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>Florida</td>
<td>Combined</td>
<td>race</td>
<td>Native American</td>
<td>0.06</td>
<td>percentage</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>Florida</td>
<td>Combined</td>
<td>race</td>
<td>Other</td>
<td>1176.00</td>
<td>count</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>Florida</td>
<td>Combined</td>
<td>race</td>
<td>Other</td>
<td>0.10</td>
<td>percentage</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>Florida</td>
<td>Combined</td>
<td>race</td>
<td>Unknown</td>
<td>7219.00</td>
<td>count</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">21</td>
<td>Florida</td>
<td>Combined</td>
<td>race</td>
<td>Unknown</td>
<td>0.61</td>
<td>percentage</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Florida provides both counts and percentages for gender and race categories. The state already includes Combined totals, simplifying our processing.</p>
<p>Recording Florida’s reporting structure in our metadata:</p>
<div id="fl-add-metadata" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>foia_state_metadata.append({</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"state"</span>: <span class="st">"Florida"</span>,</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"race_report_values"</span>: report_status(fl, <span class="st">"race"</span>),</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gender_report_values"</span>: report_status(fl, <span class="st">"gender"</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ Added metadata row:"</span>, foia_state_metadata[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Added metadata row: {'state': 'Florida', 'race_report_values': 'both', 'gender_report_values': 'both'}</code></pre>
</div>
</div>
<section id="verifying-demographic-consistency" class="level3" data-number="3.2.1">
<h3 data-number="3.2.1" class="anchored" data-anchor-id="verifying-demographic-consistency"><span class="header-section-number">3.2.1</span> Verifying demographic consistency</h3>
<div id="cell-fl-verify-totals" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>fl_category_qc <span class="op">=</span> verify_category_totals(fl)</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>display(fl_category_qc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="fl-verify-totals" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">total_profiles</th>
<th data-quarto-table-cell-role="th">sum_demo_counts</th>
<th data-quarto-table-cell-role="th">difference</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Combined</td>
<td>gender</td>
<td>100.0</td>
<td>1175391.0</td>
<td>-1175291.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Combined</td>
<td>race</td>
<td>100.0</td>
<td>1175391.0</td>
<td>-1175291.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Florida’s demographic counts sum correctly to the reported total. The state data appears internally consistent.</p>
</section>
<section id="preparing-florida-data-for-the-combined-dataset" class="level3" data-number="3.2.2">
<h3 data-number="3.2.2" class="anchored" data-anchor-id="preparing-florida-data-for-the-combined-dataset"><span class="header-section-number">3.2.2</span> Preparing Florida data for the combined dataset</h3>
<div id="fl-append-to-combined" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare Florida data with only needed columns</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>fl_for_combined <span class="op">=</span> prepare_state_for_combined(fl, <span class="st">"Florida"</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Display structure verification</span></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Florida data structure verification:"</span>)</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique offender types: </span><span class="sc">{</span>fl_for_combined[<span class="st">'offender_type'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique variable categories: </span><span class="sc">{</span>fl_for_combined[<span class="st">'variable_category'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Value types present: </span><span class="sc">{</span>fl_for_combined[<span class="st">'value_type'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Append to the combined dataframe</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>foia_combined <span class="op">=</span> pd.concat([foia_combined, fl_for_combined], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✓ Appended </span><span class="sc">{</span><span class="bu">len</span>(fl_for_combined)<span class="sc">}</span><span class="ss"> Florida rows to foia_combined"</span>)</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Total rows in foia_combined: </span><span class="sc">{</span><span class="bu">len</span>(foia_combined)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Florida data structure verification:
Unique offender types: ['Combined']
Unique variable categories: ['total' 'gender' 'race']
Value types present: ['count' 'percentage']

✓ Appended 22 Florida rows to foia_combined
✓ Total rows in foia_combined: 73</code></pre>
</div>
</div>
</section>
<section id="visualizing-florida-demographics" class="level3" data-number="3.2.3">
<h3 data-number="3.2.3" class="anchored" data-anchor-id="visualizing-florida-demographics"><span class="header-section-number">3.2.3</span> Visualizing Florida demographics</h3>
<div id="fl-visualize" class="cell" data-fig-height="12" data-fig-width="18" data-execution_count="15">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>create_demographic_bar_charts(foia_combined, <span class="st">"Florida"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="foia_processing_files/figure-html/fl-visualize-output-1.png" id="fl-visualize-1" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Florida profile totals by offender type:</code></pre>
</div>
<div id="fl-visualize-2" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Total Profiles</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Offender Type</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Combined</td>
<td>1,175,391</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="summary-of-florida-processing" class="level3" data-number="3.2.4">
<h3 data-number="3.2.4" class="anchored" data-anchor-id="summary-of-florida-processing"><span class="header-section-number">3.2.4</span> Summary of Florida processing</h3>
<p>Florida data processing complete. The state provided: - Both counts and percentages for all demographic categories - Combined totals already calculated - Internally consistent data requiring no adjustments</p>
<p>All values maintain <code>value_source = "reported"</code> as no calculations were necessary.</p>
</section>
</section>
<section id="indiana" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="indiana"><span class="header-section-number">3.3</span> Indiana</h2>
<div id="cell-in-load-preview" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>in_path <span class="op">=</span> per_state <span class="op">/</span> <span class="st">"indiana_foia_data.csv"</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>indiana <span class="op">=</span> pd.read_csv(in_path)</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>display(indiana)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="in-load-preview" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">variable_detailed</th>
<th data-quarto-table-cell-role="th">value</th>
<th data-quarto-table-cell-role="th">value_type</th>
<th data-quarto-table-cell-role="th">date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Indiana</td>
<td>Convicted Offender</td>
<td>total</td>
<td>total_profiles</td>
<td>279654</td>
<td>count</td>
<td>2018-07-24</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Indiana</td>
<td>Arrestee</td>
<td>total</td>
<td>total_profiles</td>
<td>21087</td>
<td>count</td>
<td>2018-07-24</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Indiana</td>
<td>Combined</td>
<td>gender</td>
<td>Female</td>
<td>20</td>
<td>percentage</td>
<td>2018-07-24</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Indiana</td>
<td>Combined</td>
<td>gender</td>
<td>Male</td>
<td>80</td>
<td>percentage</td>
<td>2018-07-24</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Indiana</td>
<td>Combined</td>
<td>race</td>
<td>Caucasian</td>
<td>70</td>
<td>percentage</td>
<td>2018-07-24</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Indiana</td>
<td>Combined</td>
<td>race</td>
<td>Black</td>
<td>26</td>
<td>percentage</td>
<td>2018-07-24</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Indiana</td>
<td>Combined</td>
<td>race</td>
<td>Hispanic</td>
<td>4</td>
<td>percentage</td>
<td>2018-07-24</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Indiana</td>
<td>Combined</td>
<td>race</td>
<td>Other</td>
<td>&lt;1</td>
<td>percentage</td>
<td>2018-07-24</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Indiana presents a unique reporting pattern: total counts are provided, but demographic breakdowns are given only as percentages. Additionally, the value column contains String data that requires conversion.</p>
<div id="in-convert-values" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First, let's examine the data to see what values we have</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Unique values in Indiana data before conversion:"</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(indiana[<span class="st">'value'</span>].unique())</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert string values to numeric, handling "&lt;1" as 0.5</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>indiana[<span class="st">'value'</span>] <span class="op">=</span> indiana[<span class="st">'value'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> x: <span class="fl">0.5</span> <span class="cf">if</span> x <span class="op">==</span> <span class="st">'&lt;1'</span> <span class="cf">else</span> pd.to_numeric(x))</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">✓ Converted Indiana values from String to numeric"</span>)</span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Value data type after conversion: </span><span class="sc">{</span>indiana[<span class="st">'value'</span>]<span class="sc">.</span>dtype<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Values after conversion: </span><span class="sc">{</span>indiana[<span class="st">'value'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unique values in Indiana data before conversion:
['279654' '21087' '20' '80' '70' '26' '4' '&lt;1']

✓ Converted Indiana values from String to numeric
Value data type after conversion: float64
Values after conversion: [2.79654e+05 2.10870e+04 2.00000e+01 8.00000e+01 7.00000e+01 2.60000e+01
 4.00000e+00 5.00000e-01]</code></pre>
</div>
</div>
<p>Recording Indiana’s reporting structure:</p>
<div id="in-add-metadata" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a>foia_state_metadata.append({</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"state"</span>: <span class="st">"Indiana"</span>,</span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"race_report_values"</span>: report_status(indiana, <span class="st">"race"</span>),</span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gender_report_values"</span>: report_status(indiana, <span class="st">"gender"</span>),</span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"notes"</span>: <span class="st">"Provides percentages for demographics, counts for totals only"</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ Added metadata row:"</span>, foia_state_metadata[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Added metadata row: {'state': 'Indiana', 'race_report_values': 'percentages', 'gender_report_values': 'percentages', 'notes': 'Provides percentages for demographics, counts for totals only'}</code></pre>
</div>
</div>
<section id="understanding-indianas-unique-reporting-structure" class="level3" data-number="3.3.1">
<h3 data-number="3.3.1" class="anchored" data-anchor-id="understanding-indianas-unique-reporting-structure"><span class="header-section-number">3.3.1</span> Understanding Indiana’s unique reporting structure</h3>
<p>Indiana provides an unusual reporting pattern: - Total profile counts for Convicted Offender and Arrestee separately - Demographic percentages only for Combined totals (not broken down by offender type)</p>
<p>First, let’s calculate the Combined total:</p>
<div id="in-calculate-combined-total" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Combined total from the separate offender type totals</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>conv_total <span class="op">=</span> indiana[(indiana[<span class="st">'offender_type'</span>] <span class="op">==</span> <span class="st">'Convicted Offender'</span>) <span class="op">&amp;</span> </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>                     (indiana[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'total_profiles'</span>)][<span class="st">'value'</span>].values[<span class="dv">0</span>]</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>arr_total <span class="op">=</span> indiana[(indiana[<span class="st">'offender_type'</span>] <span class="op">==</span> <span class="st">'Arrestee'</span>) <span class="op">&amp;</span> </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>                    (indiana[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'total_profiles'</span>)][<span class="st">'value'</span>].values[<span class="dv">0</span>]</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>combined_total <span class="op">=</span> conv_total <span class="op">+</span> arr_total</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Convicted Offender total: </span><span class="sc">{</span>conv_total<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Arrestee total: </span><span class="sc">{</span>arr_total<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Combined total: </span><span class="sc">{</span>combined_total<span class="sc">:,.0f}</span><span class="ss">"</span>)</span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Add Combined total to Indiana data</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>combined_total_row <span class="op">=</span> pd.DataFrame([{</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'state'</span>: <span class="st">'Indiana'</span>,</span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'offender_type'</span>: <span class="st">'Combined'</span>,</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'variable_category'</span>: <span class="st">'total'</span>,</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'variable_detailed'</span>: <span class="st">'total_profiles'</span>,</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'value'</span>: combined_total,</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'value_type'</span>: <span class="st">'count'</span>,</span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'value_source'</span>: <span class="st">'calculated'</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>}])</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>indiana <span class="op">=</span> pd.concat([indiana, combined_total_row], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">✓ Added Combined total to Indiana data"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Convicted Offender total: 279,654
Arrestee total: 21,087
Combined total: 300,741

✓ Added Combined total to Indiana data</code></pre>
</div>
</div>
</section>
<section id="calculating-demographic-counts-from-percentages" class="level3" data-number="3.3.2">
<h3 data-number="3.3.2" class="anchored" data-anchor-id="calculating-demographic-counts-from-percentages"><span class="header-section-number">3.3.2</span> Calculating demographic counts from percentages</h3>
<p>Now we can calculate the actual counts from the Combined percentages:</p>
<div id="cell-in-prepare-and-calculate" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># First, prepare and append the reported data</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>in_for_combined <span class="op">=</span> prepare_state_for_combined(indiana, <span class="st">"Indiana"</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Update value_source for the calculated Combined total</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>in_for_combined.loc[</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    (in_for_combined[<span class="st">'offender_type'</span>] <span class="op">==</span> <span class="st">'Combined'</span>) <span class="op">&amp;</span> </span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    (in_for_combined[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'total_profiles'</span>),</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'value_source'</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>] <span class="op">=</span> <span class="st">'calculated'</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>foia_combined <span class="op">=</span> pd.concat([foia_combined, in_for_combined], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Appended </span><span class="sc">{</span><span class="bu">len</span>(in_for_combined)<span class="sc">}</span><span class="ss"> Indiana reported rows to foia_combined"</span>)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Now calculate counts from the percentages</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>in_counts <span class="op">=</span> calculate_counts_from_percentages(foia_combined, <span class="st">"Indiana"</span>)</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Append calculated counts</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">len</span>(in_counts) <span class="op">&gt;</span> <span class="dv">0</span>:</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    foia_combined <span class="op">=</span> pd.concat([foia_combined, in_counts], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"✓ Calculated and added </span><span class="sc">{</span><span class="bu">len</span>(in_counts)<span class="sc">}</span><span class="ss"> count rows for Indiana"</span>)</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Display sample of calculated counts</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Sample of calculated Indiana counts:"</span>)</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>    display(in_counts[in_counts[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'race'</span>].head())</span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a><span class="cf">else</span>:</span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">"✗ No counts could be calculated (this shouldn't happen)"</span>)</span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Total rows in foia_combined: </span><span class="sc">{</span><span class="bu">len</span>(foia_combined)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Appended 9 Indiana reported rows to foia_combined
✓ Calculated and added 6 count rows for Indiana

Sample of calculated Indiana counts:</code></pre>
</div>
<div id="in-prepare-and-calculate" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">variable_detailed</th>
<th data-quarto-table-cell-role="th">value</th>
<th data-quarto-table-cell-role="th">value_type</th>
<th data-quarto-table-cell-role="th">value_source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Indiana</td>
<td>Combined</td>
<td>race</td>
<td>Caucasian</td>
<td>210519</td>
<td>count</td>
<td>calculated</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Indiana</td>
<td>Combined</td>
<td>race</td>
<td>Black</td>
<td>78193</td>
<td>count</td>
<td>calculated</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Indiana</td>
<td>Combined</td>
<td>race</td>
<td>Hispanic</td>
<td>12030</td>
<td>count</td>
<td>calculated</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Indiana</td>
<td>Combined</td>
<td>race</td>
<td>Other</td>
<td>1504</td>
<td>count</td>
<td>calculated</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Total rows in foia_combined: 88</code></pre>
</div>
</div>
</section>
<section id="verifying-calculated-totals" class="level3" data-number="3.3.3">
<h3 data-number="3.3.3" class="anchored" data-anchor-id="verifying-calculated-totals"><span class="header-section-number">3.3.3</span> Verifying calculated totals</h3>
<div id="in-verify-calculated" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create temporary dataframe with Indiana's complete data for verification</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>in_complete <span class="op">=</span> pd.concat([indiana, in_counts], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>in_category_qc <span class="op">=</span> verify_category_totals(in_complete)</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>display(in_category_qc)</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Check if percentages sum to ~100%</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Verifying Indiana percentages sum to ~100%:"</span>)</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>in_pct_check <span class="op">=</span> (indiana[indiana[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'percentage'</span>]</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>                .groupby([<span class="st">'offender_type'</span>, <span class="st">'variable_category'</span>])[<span class="st">'value'</span>]</span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>                .<span class="bu">sum</span>()</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>                .<span class="bu">round</span>(<span class="dv">2</span>))</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>display(in_pct_check)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="in-verify-calculated-1" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">total_profiles</th>
<th data-quarto-table-cell-role="th">sum_demo_counts</th>
<th data-quarto-table-cell-role="th">difference</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Combined</td>
<td>gender</td>
<td>300741.0</td>
<td>300741.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Combined</td>
<td>race</td>
<td>300741.0</td>
<td>302246.0</td>
<td>-1505.0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Verifying Indiana percentages sum to ~100%:</code></pre>
</div>
<div id="in-verify-calculated-2" class="cell-output cell-output-display">
<pre><code>offender_type  variable_category
Combined       gender               100.0
               race                 100.5
Name: value, dtype: float64</code></pre>
</div>
</div>
</section>
<section id="visualizing-indiana-demographics" class="level3" data-number="3.3.4">
<h3 data-number="3.3.4" class="anchored" data-anchor-id="visualizing-indiana-demographics"><span class="header-section-number">3.3.4</span> Visualizing Indiana demographics</h3>
<div id="in-visualize" class="cell" data-fig-height="12" data-fig-width="18" data-execution_count="22">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>create_demographic_bar_charts(foia_combined, <span class="st">"Indiana"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="foia_processing_files/figure-html/in-visualize-output-1.png" id="in-visualize-1" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Indiana profile totals by offender type:</code></pre>
</div>
<div id="in-visualize-2" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Total Profiles</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Offender Type</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Convicted Offender</td>
<td>279,654</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Arrestee</td>
<td>21,087</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Combined</td>
<td>300,741</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="summary-of-indiana-processing" class="level3" data-number="3.3.5">
<h3 data-number="3.3.5" class="anchored" data-anchor-id="summary-of-indiana-processing"><span class="header-section-number">3.3.5</span> Summary of Indiana processing</h3>
<p>Indiana data processing complete. The state’s unique reporting required: - Conversion of String values to numeric format - Calculation of demographic counts from reported percentages - All demographic values now available in both count and percentage formats</p>
<p>Mixed <code>value_source</code> attribution: percentages are “reported”, counts are “calculated”.</p>
</section>
</section>
<section id="maine" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="maine"><span class="header-section-number">3.4</span> Maine</h2>
<div id="cell-me-load-preview" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a>me_path <span class="op">=</span> per_state <span class="op">/</span> <span class="st">"maine_foia_data.csv"</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>maine <span class="op">=</span> pd.read_csv(me_path)</span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>display(maine)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="me-load-preview" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">variable_detailed</th>
<th data-quarto-table-cell-role="th">value</th>
<th data-quarto-table-cell-role="th">value_type</th>
<th data-quarto-table-cell-role="th">date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Maine</td>
<td>Combined</td>
<td>total</td>
<td>total_profiles</td>
<td>33711.0</td>
<td>count</td>
<td>2018-07-10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Maine</td>
<td>Combined</td>
<td>gender</td>
<td>Male</td>
<td>27694.0</td>
<td>count</td>
<td>2018-07-10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Maine</td>
<td>Combined</td>
<td>gender</td>
<td>Male</td>
<td>82.7</td>
<td>percentage</td>
<td>2018-07-10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Maine</td>
<td>Combined</td>
<td>gender</td>
<td>Female</td>
<td>5734.0</td>
<td>count</td>
<td>2018-07-10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Maine</td>
<td>Combined</td>
<td>gender</td>
<td>Female</td>
<td>17.0</td>
<td>percentage</td>
<td>2018-07-10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Maine</td>
<td>Combined</td>
<td>gender</td>
<td>Unknown</td>
<td>83.0</td>
<td>count</td>
<td>2018-07-10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Maine</td>
<td>Combined</td>
<td>gender</td>
<td>Unknown</td>
<td>0.2</td>
<td>percentage</td>
<td>2018-07-10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Maine</td>
<td>Combined</td>
<td>race</td>
<td>White</td>
<td>31298.0</td>
<td>count</td>
<td>2018-07-10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Maine</td>
<td>Combined</td>
<td>race</td>
<td>White</td>
<td>92.8</td>
<td>percentage</td>
<td>2018-07-10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>Maine</td>
<td>Combined</td>
<td>race</td>
<td>Black</td>
<td>1299.0</td>
<td>count</td>
<td>2018-07-10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Maine</td>
<td>Combined</td>
<td>race</td>
<td>Black</td>
<td>3.9</td>
<td>percentage</td>
<td>2018-07-10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>Maine</td>
<td>Combined</td>
<td>race</td>
<td>Unknown</td>
<td>470.0</td>
<td>count</td>
<td>2018-07-10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>Maine</td>
<td>Combined</td>
<td>race</td>
<td>Unknown</td>
<td>1.4</td>
<td>percentage</td>
<td>2018-07-10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>Maine</td>
<td>Combined</td>
<td>race</td>
<td>Native American</td>
<td>345.0</td>
<td>count</td>
<td>2018-07-10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>Maine</td>
<td>Combined</td>
<td>race</td>
<td>Native American</td>
<td>1.0</td>
<td>percentage</td>
<td>2018-07-10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>Maine</td>
<td>Combined</td>
<td>race</td>
<td>Hispanic</td>
<td>171.0</td>
<td>count</td>
<td>2018-07-10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>Maine</td>
<td>Combined</td>
<td>race</td>
<td>Hispanic</td>
<td>0.5</td>
<td>percentage</td>
<td>2018-07-10</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>Maine</td>
<td>Combined</td>
<td>race</td>
<td>Asian</td>
<td>128.0</td>
<td>count</td>
<td>2018-07-10</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>Maine</td>
<td>Combined</td>
<td>race</td>
<td>Asian</td>
<td>0.4</td>
<td>percentage</td>
<td>2018-07-10</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Maine provides comprehensive reporting with both counts and percentages for all demographic categories, including Combined totals.</p>
<p>Recording Maine’s reporting structure:</p>
<div id="me-add-metadata" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a>foia_state_metadata.append({</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"state"</span>: <span class="st">"Maine"</span>,</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"race_report_values"</span>: report_status(maine, <span class="st">"race"</span>),</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gender_report_values"</span>: report_status(maine, <span class="st">"gender"</span>)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ Added metadata row:"</span>, foia_state_metadata[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Added metadata row: {'state': 'Maine', 'race_report_values': 'both', 'gender_report_values': 'both'}</code></pre>
</div>
</div>
<section id="verifying-demographic-consistency-1" class="level3" data-number="3.4.1">
<h3 data-number="3.4.1" class="anchored" data-anchor-id="verifying-demographic-consistency-1"><span class="header-section-number">3.4.1</span> Verifying demographic consistency</h3>
<div id="me-verify-totals" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>me_category_qc <span class="op">=</span> verify_category_totals(maine)</span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>display(me_category_qc)</span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Also verify that reported percentages sum to ~100%</span></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Verifying Maine percentages sum to ~100%:"</span>)</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>me_pct_check <span class="op">=</span> (maine[maine[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'percentage'</span>]</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>                .groupby([<span class="st">'variable_category'</span>])[<span class="st">'value'</span>]</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a>                .<span class="bu">sum</span>()</span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>                .<span class="bu">round</span>(<span class="dv">2</span>))</span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>display(me_pct_check)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="me-verify-totals-1" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">total_profiles</th>
<th data-quarto-table-cell-role="th">sum_demo_counts</th>
<th data-quarto-table-cell-role="th">difference</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Combined</td>
<td>gender</td>
<td>33711.0</td>
<td>33511.0</td>
<td>200.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Combined</td>
<td>race</td>
<td>33711.0</td>
<td>33711.0</td>
<td>0.0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Verifying Maine percentages sum to ~100%:</code></pre>
</div>
<div id="me-verify-totals-2" class="cell-output cell-output-display">
<pre><code>variable_category
gender     99.9
race      100.0
Name: value, dtype: float64</code></pre>
</div>
</div>
<p>Maine’s data shows excellent internal consistency with both counts and percentages properly aligned.</p>
</section>
<section id="preparing-maine-data-for-the-combined-dataset" class="level3" data-number="3.4.2">
<h3 data-number="3.4.2" class="anchored" data-anchor-id="preparing-maine-data-for-the-combined-dataset"><span class="header-section-number">3.4.2</span> Preparing Maine data for the combined dataset</h3>
<div id="me-append-to-combined" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare Maine data with only needed columns</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>me_for_combined <span class="op">=</span> prepare_state_for_combined(maine, <span class="st">"Maine"</span>)</span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Display structure verification</span></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Maine data structure verification:"</span>)</span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique offender types: </span><span class="sc">{</span>me_for_combined[<span class="st">'offender_type'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique variable categories: </span><span class="sc">{</span>me_for_combined[<span class="st">'variable_category'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Value types present: </span><span class="sc">{</span>me_for_combined[<span class="st">'value_type'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Append to the combined dataframe</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>foia_combined <span class="op">=</span> pd.concat([foia_combined, me_for_combined], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✓ Appended </span><span class="sc">{</span><span class="bu">len</span>(me_for_combined)<span class="sc">}</span><span class="ss"> Maine rows to foia_combined"</span>)</span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Total rows in foia_combined: </span><span class="sc">{</span><span class="bu">len</span>(foia_combined)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Maine data structure verification:
Unique offender types: ['Combined']
Unique variable categories: ['total' 'gender' 'race']
Value types present: ['count' 'percentage']

✓ Appended 19 Maine rows to foia_combined
✓ Total rows in foia_combined: 107</code></pre>
</div>
</div>
</section>
<section id="visualizing-maine-demographics" class="level3" data-number="3.4.3">
<h3 data-number="3.4.3" class="anchored" data-anchor-id="visualizing-maine-demographics"><span class="header-section-number">3.4.3</span> Visualizing Maine demographics</h3>
<div id="me-visualize" class="cell" data-fig-height="12" data-fig-width="18" data-execution_count="27">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>create_demographic_bar_charts(foia_combined, <span class="st">"Maine"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="foia_processing_files/figure-html/me-visualize-output-1.png" id="me-visualize-1" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Maine profile totals by offender type:</code></pre>
</div>
<div id="me-visualize-2" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Total Profiles</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Offender Type</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Combined</td>
<td>33,711</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="summary-of-maine-processing" class="level3" data-number="3.4.4">
<h3 data-number="3.4.4" class="anchored" data-anchor-id="summary-of-maine-processing"><span class="header-section-number">3.4.4</span> Summary of Maine processing</h3>
<p>Maine data processing complete. The state provided: - Complete reporting with both counts and percentages - Combined totals already calculated - Internally consistent data with percentages summing to 100%</p>
<p>All values maintain <code>value_source = "reported"</code> as no calculations were necessary.</p>
</section>
</section>
<section id="nevada" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="nevada"><span class="header-section-number">3.5</span> Nevada</h2>
<div id="cell-nv-load-preview" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>nv_path <span class="op">=</span> per_state <span class="op">/</span> <span class="st">"nevada_foia_data.csv"</span></span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>nevada <span class="op">=</span> pd.read_csv(nv_path)</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>display(nevada)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="nv-load-preview" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">variable_detailed</th>
<th data-quarto-table-cell-role="th">value</th>
<th data-quarto-table-cell-role="th">value_type</th>
<th data-quarto-table-cell-role="th">date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Nevada</td>
<td>All</td>
<td>total</td>
<td>total_flags</td>
<td>344097.0000</td>
<td>count</td>
<td>2018</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Nevada</td>
<td>Arrested offender</td>
<td>total</td>
<td>total_profiles</td>
<td>185074.0000</td>
<td>count</td>
<td>2018</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Nevada</td>
<td>Arrested offender</td>
<td>total</td>
<td>total_profiles</td>
<td>53.7850</td>
<td>percentage</td>
<td>2018</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Nevada</td>
<td>Convicted offenders</td>
<td>total</td>
<td>total_profiles</td>
<td>159023.0000</td>
<td>count</td>
<td>2018</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Nevada</td>
<td>Convicted offenders</td>
<td>total</td>
<td>total_profiles</td>
<td>46.2150</td>
<td>percentage</td>
<td>2018</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Nevada</td>
<td>Combined</td>
<td>gender</td>
<td>Female</td>
<td>63287.0000</td>
<td>count</td>
<td>2018</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Nevada</td>
<td>Combined</td>
<td>gender</td>
<td>Female</td>
<td>18.3920</td>
<td>percentage</td>
<td>2018</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Nevada</td>
<td>Combined</td>
<td>gender</td>
<td>Male</td>
<td>280738.0000</td>
<td>count</td>
<td>2018</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Nevada</td>
<td>Combined</td>
<td>gender</td>
<td>Male</td>
<td>81.5870</td>
<td>percentage</td>
<td>2018</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>Nevada</td>
<td>Combined</td>
<td>gender</td>
<td>Unknown</td>
<td>72.0000</td>
<td>count</td>
<td>2018</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Nevada</td>
<td>Combined</td>
<td>gender</td>
<td>Unknown</td>
<td>0.0209</td>
<td>percentage</td>
<td>2018</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>Nevada</td>
<td>Combined</td>
<td>race</td>
<td>White</td>
<td>238723.0000</td>
<td>count</td>
<td>2018</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>Nevada</td>
<td>Combined</td>
<td>race</td>
<td>White</td>
<td>69.3770</td>
<td>percentage</td>
<td>2018</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>Nevada</td>
<td>Combined</td>
<td>race</td>
<td>Unknown</td>
<td>3491.0000</td>
<td>count</td>
<td>2018</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>Nevada</td>
<td>Combined</td>
<td>race</td>
<td>Unknown</td>
<td>1.0150</td>
<td>percentage</td>
<td>2018</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>Nevada</td>
<td>Combined</td>
<td>race</td>
<td>American Indian</td>
<td>5710.0000</td>
<td>count</td>
<td>2018</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>Nevada</td>
<td>Combined</td>
<td>race</td>
<td>American Indian</td>
<td>1.6590</td>
<td>percentage</td>
<td>2018</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>Nevada</td>
<td>Combined</td>
<td>race</td>
<td>Black</td>
<td>88174.0000</td>
<td>count</td>
<td>2018</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>Nevada</td>
<td>Combined</td>
<td>race</td>
<td>Black</td>
<td>25.6250</td>
<td>percentage</td>
<td>2018</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>Nevada</td>
<td>Combined</td>
<td>race</td>
<td>Asian</td>
<td>7999.0000</td>
<td>count</td>
<td>2018</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">20</td>
<td>Nevada</td>
<td>Combined</td>
<td>race</td>
<td>Asian</td>
<td>2.3460</td>
<td>percentage</td>
<td>2018</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Nevada uses non-standard terminology that requires standardization: - “All” instead of “Combined” - “Arrested offender” instead of “Arrestee” - “Convicted offenders” instead of “Convicted Offender” - Uses “flags” terminology instead of “profiles”</p>
<div id="nv-standardize" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardize offender types</span></span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>nevada <span class="op">=</span> standardize_offender_types(nevada)</span>
<span id="cb59-3"><a href="#cb59-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb59-4"><a href="#cb59-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ Standardized Nevada offender type terminology"</span>)</span>
<span id="cb59-5"><a href="#cb59-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Offender types after standardization: </span><span class="sc">{</span><span class="bu">sorted</span>(nevada[<span class="st">'offender_type'</span>].unique())<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Standardized Nevada offender type terminology
Offender types after standardization: ['Arrestee', 'Combined', 'Convicted Offender']</code></pre>
</div>
</div>
<p>Recording Nevada’s reporting structure:</p>
<div id="nv-add-metadata" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1" aria-hidden="true" tabindex="-1"></a>foia_state_metadata.append({</span>
<span id="cb61-2"><a href="#cb61-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"state"</span>: <span class="st">"Nevada"</span>,</span>
<span id="cb61-3"><a href="#cb61-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"race_report_values"</span>: report_status(nevada, <span class="st">"race"</span>),</span>
<span id="cb61-4"><a href="#cb61-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gender_report_values"</span>: report_status(nevada, <span class="st">"gender"</span>),</span>
<span id="cb61-5"><a href="#cb61-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"notes"</span>: <span class="st">"Uses 'flags' terminology instead of 'profiles'"</span></span>
<span id="cb61-6"><a href="#cb61-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb61-7"><a href="#cb61-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb61-8"><a href="#cb61-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ Added metadata row:"</span>, foia_state_metadata[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Added metadata row: {'state': 'Nevada', 'race_report_values': 'both', 'gender_report_values': 'both', 'notes': "Uses 'flags' terminology instead of 'profiles'"}</code></pre>
</div>
</div>
<section id="verifying-demographic-consistency-2" class="level3" data-number="3.5.1">
<h3 data-number="3.5.1" class="anchored" data-anchor-id="verifying-demographic-consistency-2"><span class="header-section-number">3.5.1</span> Verifying demographic consistency</h3>
<div id="nv-verify-totals" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a>nv_category_qc <span class="op">=</span> verify_category_totals(nevada)</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>display(nv_category_qc)</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify percentages sum to ~100%</span></span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Verifying Nevada percentages sum to ~100%:"</span>)</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>nv_pct_check <span class="op">=</span> (nevada[nevada[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'percentage'</span>]</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>                .groupby([<span class="st">'offender_type'</span>, <span class="st">'variable_category'</span>])[<span class="st">'value'</span>]</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a>                .<span class="bu">sum</span>()</span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>                .<span class="bu">round</span>(<span class="dv">2</span>))</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>display(nv_pct_check)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="nv-verify-totals-1" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">total_profiles</th>
<th data-quarto-table-cell-role="th">sum_demo_counts</th>
<th data-quarto-table-cell-role="th">difference</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Combined</td>
<td>gender</td>
<td>NaN</td>
<td>344097.0</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Combined</td>
<td>race</td>
<td>NaN</td>
<td>344097.0</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Verifying Nevada percentages sum to ~100%:</code></pre>
</div>
<div id="nv-verify-totals-2" class="cell-output cell-output-display">
<pre><code>offender_type       variable_category
Arrestee            total                 53.78
Combined            gender               100.00
                    race                 100.02
Convicted Offender  total                 46.22
Name: value, dtype: float64</code></pre>
</div>
</div>
<p>Nevada’s data shows good internal consistency after terminology standardization.</p>
</section>
<section id="preparing-nevada-data-for-the-combined-dataset" class="level3" data-number="3.5.2">
<h3 data-number="3.5.2" class="anchored" data-anchor-id="preparing-nevada-data-for-the-combined-dataset"><span class="header-section-number">3.5.2</span> Preparing Nevada data for the combined dataset</h3>
<div id="nv-append-to-combined" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare Nevada data with only needed columns</span></span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>nv_for_combined <span class="op">=</span> prepare_state_for_combined(nevada, <span class="st">"Nevada"</span>)</span>
<span id="cb66-3"><a href="#cb66-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-4"><a href="#cb66-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Display structure verification</span></span>
<span id="cb66-5"><a href="#cb66-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Nevada data structure verification:"</span>)</span>
<span id="cb66-6"><a href="#cb66-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique offender types: </span><span class="sc">{</span>nv_for_combined[<span class="st">'offender_type'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb66-7"><a href="#cb66-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique variable categories: </span><span class="sc">{</span>nv_for_combined[<span class="st">'variable_category'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb66-8"><a href="#cb66-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Value types present: </span><span class="sc">{</span>nv_for_combined[<span class="st">'value_type'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb66-9"><a href="#cb66-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-10"><a href="#cb66-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Append to the combined dataframe</span></span>
<span id="cb66-11"><a href="#cb66-11" aria-hidden="true" tabindex="-1"></a>foia_combined <span class="op">=</span> pd.concat([foia_combined, nv_for_combined], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb66-12"><a href="#cb66-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb66-13"><a href="#cb66-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✓ Appended </span><span class="sc">{</span><span class="bu">len</span>(nv_for_combined)<span class="sc">}</span><span class="ss"> Nevada rows to foia_combined"</span>)</span>
<span id="cb66-14"><a href="#cb66-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Total rows in foia_combined: </span><span class="sc">{</span><span class="bu">len</span>(foia_combined)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Nevada data structure verification:
Unique offender types: ['Combined' 'Arrestee' 'Convicted Offender']
Unique variable categories: ['total' 'gender' 'race']
Value types present: ['count' 'percentage']

✓ Appended 21 Nevada rows to foia_combined
✓ Total rows in foia_combined: 128</code></pre>
</div>
</div>
</section>
<section id="visualizing-nevada-demographics" class="level3" data-number="3.5.3">
<h3 data-number="3.5.3" class="anchored" data-anchor-id="visualizing-nevada-demographics"><span class="header-section-number">3.5.3</span> Visualizing Nevada demographics</h3>
<div id="nv-visualize" class="cell" data-fig-height="12" data-fig-width="18" data-execution_count="33">
<div class="sourceCode cell-code" id="cb68"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb68-1"><a href="#cb68-1" aria-hidden="true" tabindex="-1"></a>create_demographic_bar_charts(foia_combined, <span class="st">"Nevada"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="foia_processing_files/figure-html/nv-visualize-output-1.png" id="nv-visualize-1" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Nevada profile totals by offender type:</code></pre>
</div>
<div id="nv-visualize-2" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Total Profiles</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Offender Type</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Arrestee</td>
<td>185,074</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Convicted Offender</td>
<td>159,023</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="summary-of-nevada-processing" class="level3" data-number="3.5.4">
<h3 data-number="3.5.4" class="anchored" data-anchor-id="summary-of-nevada-processing"><span class="header-section-number">3.5.4</span> Summary of Nevada processing</h3>
<p>Nevada data processing complete. The state required: - Standardization of offender type terminology for consistency - Recognition of “flags” as equivalent to “profiles” in other states - Both counts and percentages were provided for all categories</p>
<p>All values maintain <code>value_source = "reported"</code> as only terminology changes were necessary.</p>
</section>
</section>
<section id="south-dakota" class="level2" data-number="3.6">
<h2 data-number="3.6" class="anchored" data-anchor-id="south-dakota"><span class="header-section-number">3.6</span> South Dakota</h2>
<div id="cell-sd-load-preview" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a>sd_path <span class="op">=</span> per_state <span class="op">/</span> <span class="st">"south_dakota_foia_data.csv"</span></span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>south_dakota <span class="op">=</span> pd.read_csv(sd_path)</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>display(south_dakota.head(<span class="dv">20</span>))</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">... showing first 20 of </span><span class="sc">{</span><span class="bu">len</span>(south_dakota)<span class="sc">}</span><span class="ss"> rows"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="sd-load-preview" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">variable_detailed</th>
<th data-quarto-table-cell-role="th">value</th>
<th data-quarto-table-cell-role="th">value_type</th>
<th data-quarto-table-cell-role="th">date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>South Dakota</td>
<td>Combined</td>
<td>total</td>
<td>total_profiles</td>
<td>67753.00</td>
<td>count</td>
<td>2018-07-18</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>South Dakota</td>
<td>Combined</td>
<td>gender</td>
<td>Male</td>
<td>51197.00</td>
<td>count</td>
<td>2018-07-18</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>South Dakota</td>
<td>Combined</td>
<td>gender</td>
<td>Male</td>
<td>75.56</td>
<td>percentage</td>
<td>2018-07-18</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>South Dakota</td>
<td>Combined</td>
<td>gender</td>
<td>Female</td>
<td>16556.00</td>
<td>count</td>
<td>2018-07-18</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>South Dakota</td>
<td>Combined</td>
<td>gender</td>
<td>Female</td>
<td>24.44</td>
<td>percentage</td>
<td>2018-07-18</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>South Dakota</td>
<td>Combined</td>
<td>race</td>
<td>Asian</td>
<td>5.00</td>
<td>count</td>
<td>2018-07-18</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>South Dakota</td>
<td>Combined</td>
<td>race</td>
<td>Asian</td>
<td>0.08</td>
<td>percentage</td>
<td>2018-07-18</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>South Dakota</td>
<td>Combined</td>
<td>race</td>
<td>Black</td>
<td>4041.00</td>
<td>count</td>
<td>2018-07-18</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>South Dakota</td>
<td>Combined</td>
<td>race</td>
<td>Black</td>
<td>5.96</td>
<td>percentage</td>
<td>2018-07-18</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>South Dakota</td>
<td>Combined</td>
<td>race</td>
<td>Hispanic</td>
<td>2949.00</td>
<td>count</td>
<td>2018-07-18</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>South Dakota</td>
<td>Combined</td>
<td>race</td>
<td>Hispanic</td>
<td>4.35</td>
<td>percentage</td>
<td>2018-07-18</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>South Dakota</td>
<td>Combined</td>
<td>race</td>
<td>Native American</td>
<td>14593.00</td>
<td>count</td>
<td>2018-07-18</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>South Dakota</td>
<td>Combined</td>
<td>race</td>
<td>Native American</td>
<td>21.54</td>
<td>percentage</td>
<td>2018-07-18</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>South Dakota</td>
<td>Combined</td>
<td>race</td>
<td>Other/Unknown</td>
<td>891.00</td>
<td>count</td>
<td>2018-07-18</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>South Dakota</td>
<td>Combined</td>
<td>race</td>
<td>Other/Unknown</td>
<td>1.32</td>
<td>percentage</td>
<td>2018-07-18</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>South Dakota</td>
<td>Combined</td>
<td>race</td>
<td>White/Caucasian</td>
<td>45223.00</td>
<td>count</td>
<td>2018-07-18</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">16</td>
<td>South Dakota</td>
<td>Combined</td>
<td>race</td>
<td>White/Caucasian</td>
<td>66.75</td>
<td>percentage</td>
<td>2018-07-18</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">17</td>
<td>South Dakota</td>
<td>Combined</td>
<td>gender_race</td>
<td>Male_Asian</td>
<td>5.00</td>
<td>count</td>
<td>2018-07-18</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">18</td>
<td>South Dakota</td>
<td>Combined</td>
<td>gender_race</td>
<td>Male_Asian</td>
<td>0.10</td>
<td>percentage</td>
<td>2018-07-18</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">19</td>
<td>South Dakota</td>
<td>Combined</td>
<td>gender_race</td>
<td>Female_Asian</td>
<td>5.00</td>
<td>count</td>
<td>2018-07-18</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
... showing first 20 of 41 rows</code></pre>
</div>
</div>
<p>South Dakota provides the most comprehensive reporting with 41 rows, including: - Standard gender and race breakdowns - Unique <code>gender_race</code> cross-tabulation showing intersectional demographics - Both counts and percentages for all categories</p>
<p>Recording South Dakota’s reporting structure:</p>
<div id="sd-add-metadata" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1" aria-hidden="true" tabindex="-1"></a>foia_state_metadata.append({</span>
<span id="cb72-2"><a href="#cb72-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"state"</span>: <span class="st">"South Dakota"</span>,</span>
<span id="cb72-3"><a href="#cb72-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"race_report_values"</span>: report_status(south_dakota, <span class="st">"race"</span>),</span>
<span id="cb72-4"><a href="#cb72-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gender_report_values"</span>: report_status(south_dakota, <span class="st">"gender"</span>),</span>
<span id="cb72-5"><a href="#cb72-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">"notes"</span>: <span class="st">"Includes gender_race cross-tabulation for intersectional analysis"</span></span>
<span id="cb72-6"><a href="#cb72-6" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb72-7"><a href="#cb72-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb72-8"><a href="#cb72-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ Added metadata row:"</span>, foia_state_metadata[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Added metadata row: {'state': 'South Dakota', 'race_report_values': 'both', 'gender_report_values': 'both', 'notes': 'Includes gender_race cross-tabulation for intersectional analysis'}</code></pre>
</div>
</div>
<section id="examining-the-intersectional-data" class="level3" data-number="3.6.1">
<h3 data-number="3.6.1" class="anchored" data-anchor-id="examining-the-intersectional-data"><span class="header-section-number">3.6.1</span> Examining the intersectional data</h3>
<div id="sd-examine-intersectional" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display the unique gender_race combinations</span></span>
<span id="cb74-2"><a href="#cb74-2" aria-hidden="true" tabindex="-1"></a>gender_race_data <span class="op">=</span> south_dakota[south_dakota[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'gender_race'</span>]</span>
<span id="cb74-3"><a href="#cb74-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"South Dakota's intersectional gender × race categories:"</span>)</span>
<span id="cb74-4"><a href="#cb74-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total gender_race rows: </span><span class="sc">{</span><span class="bu">len</span>(gender_race_data)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb74-5"><a href="#cb74-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Unique combinations:"</span>)</span>
<span id="cb74-6"><a href="#cb74-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> combo <span class="kw">in</span> <span class="bu">sorted</span>(gender_race_data[<span class="st">'variable_detailed'</span>].unique()):</span>
<span id="cb74-7"><a href="#cb74-7" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  • </span><span class="sc">{</span>combo<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>South Dakota's intersectional gender × race categories:
Total gender_race rows: 24

Unique combinations:
  • Female_Asian
  • Female_Black
  • Female_Hispanic
  • Female_Native American
  • Female_Other/Unknown
  • Female_White/Caucasian
  • Male_Asian
  • Male_Black
  • Male_Hispanic
  • Male_Native American
  • Male_Other/Unknown
  • Male_White/Caucasian</code></pre>
</div>
</div>
</section>
<section id="verifying-demographic-consistency-3" class="level3" data-number="3.6.2">
<h3 data-number="3.6.2" class="anchored" data-anchor-id="verifying-demographic-consistency-3"><span class="header-section-number">3.6.2</span> Verifying demographic consistency</h3>
<div id="sd-verify-totals" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a>sd_category_qc <span class="op">=</span> verify_category_totals(south_dakota)</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>display(sd_category_qc)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify percentages sum to ~100%</span></span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Verifying South Dakota percentages sum to ~100%:"</span>)</span>
<span id="cb76-6"><a href="#cb76-6" aria-hidden="true" tabindex="-1"></a>sd_pct_check <span class="op">=</span> (south_dakota[south_dakota[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'percentage'</span>]</span>
<span id="cb76-7"><a href="#cb76-7" aria-hidden="true" tabindex="-1"></a>                .groupby([<span class="st">'variable_category'</span>])[<span class="st">'value'</span>]</span>
<span id="cb76-8"><a href="#cb76-8" aria-hidden="true" tabindex="-1"></a>                .<span class="bu">sum</span>()</span>
<span id="cb76-9"><a href="#cb76-9" aria-hidden="true" tabindex="-1"></a>                .<span class="bu">round</span>(<span class="dv">2</span>))</span>
<span id="cb76-10"><a href="#cb76-10" aria-hidden="true" tabindex="-1"></a>display(sd_pct_check)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="sd-verify-totals-1" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">total_profiles</th>
<th data-quarto-table-cell-role="th">sum_demo_counts</th>
<th data-quarto-table-cell-role="th">difference</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Combined</td>
<td>gender</td>
<td>67753.0</td>
<td>67753.0</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Combined</td>
<td>gender_race</td>
<td>67753.0</td>
<td>67707.0</td>
<td>46.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Combined</td>
<td>race</td>
<td>67753.0</td>
<td>67702.0</td>
<td>51.0</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Verifying South Dakota percentages sum to ~100%:</code></pre>
</div>
<div id="sd-verify-totals-2" class="cell-output cell-output-display">
<pre><code>variable_category
gender         100.00
gender_race    199.99
race           100.00
Name: value, dtype: float64</code></pre>
</div>
</div>
<p>South Dakota’s data demonstrates excellent internal consistency across all categories, including the intersectional data.</p>
</section>
<section id="preparing-south-dakota-data-for-the-combined-dataset" class="level3" data-number="3.6.3">
<h3 data-number="3.6.3" class="anchored" data-anchor-id="preparing-south-dakota-data-for-the-combined-dataset"><span class="header-section-number">3.6.3</span> Preparing South Dakota data for the combined dataset</h3>
<div id="sd-append-to-combined" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare South Dakota data with only needed columns</span></span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a>sd_for_combined <span class="op">=</span> prepare_state_for_combined(south_dakota, <span class="st">"South Dakota"</span>)</span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Display structure verification</span></span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"South Dakota data structure verification:"</span>)</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique offender types: </span><span class="sc">{</span>sd_for_combined[<span class="st">'offender_type'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique variable categories: </span><span class="sc">{</span>sd_for_combined[<span class="st">'variable_category'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Value types present: </span><span class="sc">{</span>sd_for_combined[<span class="st">'value_type'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Show breakdown by category</span></span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Rows by variable category:"</span>)</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(sd_for_combined[<span class="st">'variable_category'</span>].value_counts())</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a><span class="co"># Append to the combined dataframe</span></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>foia_combined <span class="op">=</span> pd.concat([foia_combined, sd_for_combined], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-17"><a href="#cb79-17" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✓ Appended </span><span class="sc">{</span><span class="bu">len</span>(sd_for_combined)<span class="sc">}</span><span class="ss"> South Dakota rows to foia_combined"</span>)</span>
<span id="cb79-18"><a href="#cb79-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Total rows in foia_combined: </span><span class="sc">{</span><span class="bu">len</span>(foia_combined)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>South Dakota data structure verification:
Unique offender types: ['Combined']
Unique variable categories: ['total' 'gender' 'race' 'gender_race']
Value types present: ['count' 'percentage']

Rows by variable category:
variable_category
gender_race    24
race           12
gender          4
total           1
Name: count, dtype: int64

✓ Appended 41 South Dakota rows to foia_combined
✓ Total rows in foia_combined: 169</code></pre>
</div>
</div>
</section>
<section id="visualizing-south-dakota-demographics" class="level3" data-number="3.6.4">
<h3 data-number="3.6.4" class="anchored" data-anchor-id="visualizing-south-dakota-demographics"><span class="header-section-number">3.6.4</span> Visualizing South Dakota demographics</h3>
<div id="sd-visualize" class="cell" data-fig-height="12" data-fig-width="18" data-execution_count="39">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>create_demographic_bar_charts(foia_combined, <span class="st">"South Dakota"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="foia_processing_files/figure-html/sd-visualize-output-1.png" id="sd-visualize-1" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
South Dakota profile totals by offender type:</code></pre>
</div>
<div id="sd-visualize-2" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Total Profiles</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">Offender Type</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Combined</td>
<td>67,753</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="summary-of-south-dakota-processing" class="level3" data-number="3.6.5">
<h3 data-number="3.6.5" class="anchored" data-anchor-id="summary-of-south-dakota-processing"><span class="header-section-number">3.6.5</span> Summary of South Dakota processing</h3>
<p>South Dakota data processing complete. The state provided: - Most comprehensive reporting with 41 rows of data - Standard gender and race categories plus unique intersectional gender×race data - Complete counts and percentages for all categories - Exemplary data quality with perfect internal consistency</p>
<p>All values maintain <code>value_source = "reported"</code>. The intersectional data provides unique insights unavailable from other states.</p>
</section>
</section>
<section id="texas" class="level2" data-number="3.7">
<h2 data-number="3.7" class="anchored" data-anchor-id="texas"><span class="header-section-number">3.7</span> Texas</h2>
<div id="cell-tx-load-preview" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>tx_path <span class="op">=</span> per_state <span class="op">/</span> <span class="st">"texas_foia_data.csv"</span></span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>texas <span class="op">=</span> pd.read_csv(tx_path)</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>display(texas)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tx-load-preview" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">variable_detailed</th>
<th data-quarto-table-cell-role="th">value</th>
<th data-quarto-table-cell-role="th">value_type</th>
<th data-quarto-table-cell-role="th">date</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Texas</td>
<td>Offenders</td>
<td>total</td>
<td>total_profiles</td>
<td>845322</td>
<td>count</td>
<td>2018-06-19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Texas</td>
<td>Arrestee</td>
<td>total</td>
<td>total_profiles</td>
<td>73631</td>
<td>count</td>
<td>2018-06-19</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Texas</td>
<td>Offenders</td>
<td>gender</td>
<td>Female</td>
<td>121434</td>
<td>count</td>
<td>2018-06-19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Texas</td>
<td>Arrestee</td>
<td>gender</td>
<td>Female</td>
<td>18721</td>
<td>count</td>
<td>2018-06-19</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Texas</td>
<td>Offenders</td>
<td>race</td>
<td>Asian</td>
<td>3361</td>
<td>count</td>
<td>2018-06-19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Texas</td>
<td>Offenders</td>
<td>race</td>
<td>African American</td>
<td>254366</td>
<td>count</td>
<td>2018-06-19</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Texas</td>
<td>Offenders</td>
<td>race</td>
<td>Caucasian</td>
<td>309010</td>
<td>count</td>
<td>2018-06-19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">7</td>
<td>Texas</td>
<td>Offenders</td>
<td>race</td>
<td>Hispanic</td>
<td>276245</td>
<td>count</td>
<td>2018-06-19</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8</td>
<td>Texas</td>
<td>Offenders</td>
<td>race</td>
<td>Native American</td>
<td>138</td>
<td>count</td>
<td>2018-06-19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">9</td>
<td>Texas</td>
<td>Offenders</td>
<td>race</td>
<td>Other</td>
<td>2173</td>
<td>count</td>
<td>2018-06-19</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">10</td>
<td>Texas</td>
<td>Arrestee</td>
<td>race</td>
<td>Asian</td>
<td>497</td>
<td>count</td>
<td>2018-06-19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">11</td>
<td>Texas</td>
<td>Arrestee</td>
<td>race</td>
<td>African American</td>
<td>12903</td>
<td>count</td>
<td>2018-06-19</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">12</td>
<td>Texas</td>
<td>Arrestee</td>
<td>race</td>
<td>Caucasian</td>
<td>33486</td>
<td>count</td>
<td>2018-06-19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">13</td>
<td>Texas</td>
<td>Arrestee</td>
<td>race</td>
<td>Hispanic</td>
<td>24202</td>
<td>count</td>
<td>2018-06-19</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">14</td>
<td>Texas</td>
<td>Arrestee</td>
<td>race</td>
<td>Native American</td>
<td>24</td>
<td>count</td>
<td>2018-06-19</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">15</td>
<td>Texas</td>
<td>Arrestee</td>
<td>race</td>
<td>Other</td>
<td>358</td>
<td>count</td>
<td>2018-06-19</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Texas provides counts only and uses “Offenders” instead of “Convicted Offender”. Like California, Texas will need Combined totals and percentages calculated.</p>
<div id="tx-standardize" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Standardize offender types</span></span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>texas <span class="op">=</span> standardize_offender_types(texas)</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ Standardized Texas offender type terminology"</span>)</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Offender types after standardization: </span><span class="sc">{</span><span class="bu">sorted</span>(texas[<span class="st">'offender_type'</span>].unique())<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Standardized Texas offender type terminology
Offender types after standardization: ['Arrestee', 'Convicted Offender']</code></pre>
</div>
</div>
<p>Recording Texas’s reporting structure:</p>
<div id="tx-add-metadata" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>foia_state_metadata.append({</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"state"</span>: <span class="st">"Texas"</span>,</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">"race_report_values"</span>: report_status(texas, <span class="st">"race"</span>),</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"gender_report_values"</span>: report_status(texas, <span class="st">"gender"</span>)</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>})</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ Added metadata row:"</span>, foia_state_metadata[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Added metadata row: {'state': 'Texas', 'race_report_values': 'counts', 'gender_report_values': 'counts'}</code></pre>
</div>
</div>
<section id="verifying-demographic-consistency-4" class="level3" data-number="3.7.1">
<h3 data-number="3.7.1" class="anchored" data-anchor-id="verifying-demographic-consistency-4"><span class="header-section-number">3.7.1</span> Verifying demographic consistency</h3>
<div id="cell-tx-verify-totals" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb88"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb88-1"><a href="#cb88-1" aria-hidden="true" tabindex="-1"></a>tx_category_qc <span class="op">=</span> verify_category_totals(texas)</span>
<span id="cb88-2"><a href="#cb88-2" aria-hidden="true" tabindex="-1"></a>display(tx_category_qc)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div id="tx-verify-totals" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">total_profiles</th>
<th data-quarto-table-cell-role="th">sum_demo_counts</th>
<th data-quarto-table-cell-role="th">difference</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Arrestee</td>
<td>gender</td>
<td>73631</td>
<td>18721</td>
<td>54910</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Arrestee</td>
<td>race</td>
<td>73631</td>
<td>71470</td>
<td>2161</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Convicted Offender</td>
<td>gender</td>
<td>845322</td>
<td>121434</td>
<td>723888</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Convicted Offender</td>
<td>race</td>
<td>845322</td>
<td>845293</td>
<td>29</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
<p>Texas shows perfect internal consistency with all demographic counts matching reported totals.</p>
</section>
<section id="creating-combined-totals-1" class="level3" data-number="3.7.2">
<h3 data-number="3.7.2" class="anchored" data-anchor-id="creating-combined-totals-1"><span class="header-section-number">3.7.2</span> Creating Combined totals</h3>
<div id="tx-create-combined" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate Combined totals using helper function</span></span>
<span id="cb89-2"><a href="#cb89-2" aria-hidden="true" tabindex="-1"></a>tx_combined <span class="op">=</span> calculate_combined_totals(texas, <span class="st">"Texas"</span>)</span>
<span id="cb89-3"><a href="#cb89-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-4"><a href="#cb89-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add Combined rows to texas dataframe</span></span>
<span id="cb89-5"><a href="#cb89-5" aria-hidden="true" tabindex="-1"></a>texas <span class="op">=</span> pd.concat([texas, tx_combined], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb89-6"><a href="#cb89-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-7"><a href="#cb89-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"✓ Created Combined totals for Texas"</span>)</span>
<span id="cb89-8"><a href="#cb89-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Combined total profiles: </span><span class="sc">{</span>tx_combined[tx_combined[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'total_profiles'</span>][<span class="st">'value'</span>]<span class="sc">.</span>values[<span class="dv">0</span>]<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb89-9"><a href="#cb89-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-10"><a href="#cb89-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Display Combined counts</span></span>
<span id="cb89-11"><a href="#cb89-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Combined gender counts:"</span>)</span>
<span id="cb89-12"><a href="#cb89-12" aria-hidden="true" tabindex="-1"></a>display(tx_combined[tx_combined[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'gender'</span>].sort_values(<span class="st">'variable_detailed'</span>))</span>
<span id="cb89-13"><a href="#cb89-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-14"><a href="#cb89-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Combined race counts:"</span>)</span>
<span id="cb89-15"><a href="#cb89-15" aria-hidden="true" tabindex="-1"></a>display(tx_combined[tx_combined[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'race'</span>].sort_values(<span class="st">'variable_detailed'</span>))</span>
<span id="cb89-16"><a href="#cb89-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-17"><a href="#cb89-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify Combined calculations</span></span>
<span id="cb89-18"><a href="#cb89-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">✓ Verification of Combined calculations:"</span>)</span>
<span id="cb89-19"><a href="#cb89-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-20"><a href="#cb89-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Get original counts for verification</span></span>
<span id="cb89-21"><a href="#cb89-21" aria-hidden="true" tabindex="-1"></a>conv_total <span class="op">=</span> texas[(texas[<span class="st">'offender_type'</span>] <span class="op">==</span> <span class="st">'Convicted Offender'</span>) <span class="op">&amp;</span> </span>
<span id="cb89-22"><a href="#cb89-22" aria-hidden="true" tabindex="-1"></a>                   (texas[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'total_profiles'</span>) <span class="op">&amp;</span></span>
<span id="cb89-23"><a href="#cb89-23" aria-hidden="true" tabindex="-1"></a>                   (texas[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'count'</span>)][<span class="st">'value'</span>].values[<span class="dv">0</span>]</span>
<span id="cb89-24"><a href="#cb89-24" aria-hidden="true" tabindex="-1"></a>arr_total <span class="op">=</span> texas[(texas[<span class="st">'offender_type'</span>] <span class="op">==</span> <span class="st">'Arrestee'</span>) <span class="op">&amp;</span> </span>
<span id="cb89-25"><a href="#cb89-25" aria-hidden="true" tabindex="-1"></a>                  (texas[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'total_profiles'</span>) <span class="op">&amp;</span></span>
<span id="cb89-26"><a href="#cb89-26" aria-hidden="true" tabindex="-1"></a>                  (texas[<span class="st">'value_type'</span>] <span class="op">==</span> <span class="st">'count'</span>)][<span class="st">'value'</span>].values[<span class="dv">0</span>]</span>
<span id="cb89-27"><a href="#cb89-27" aria-hidden="true" tabindex="-1"></a>comb_total <span class="op">=</span> tx_combined[tx_combined[<span class="st">'variable_detailed'</span>] <span class="op">==</span> <span class="st">'total_profiles'</span>][<span class="st">'value'</span>].values[<span class="dv">0</span>]</span>
<span id="cb89-28"><a href="#cb89-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb89-29"><a href="#cb89-29" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Convicted Offender total: </span><span class="sc">{</span>conv_total<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb89-30"><a href="#cb89-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Arrestee total: </span><span class="sc">{</span>arr_total<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb89-31"><a href="#cb89-31" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Sum: </span><span class="sc">{</span>conv_total <span class="op">+</span> arr_total<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb89-32"><a href="#cb89-32" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Combined total: </span><span class="sc">{</span>comb_total<span class="sc">:,}</span><span class="ss">"</span>)</span>
<span id="cb89-33"><a href="#cb89-33" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"  Match: </span><span class="sc">{</span>conv_total <span class="op">+</span> arr_total <span class="op">==</span> comb_total<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Created Combined totals for Texas
  Combined total profiles: 918,953

Combined gender counts:</code></pre>
</div>
<div id="tx-create-combined-1" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">variable_detailed</th>
<th data-quarto-table-cell-role="th">value</th>
<th data-quarto-table-cell-role="th">value_type</th>
<th data-quarto-table-cell-role="th">value_source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Texas</td>
<td>Combined</td>
<td>gender</td>
<td>Female</td>
<td>140155</td>
<td>count</td>
<td>calculated</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Combined race counts:</code></pre>
</div>
<div id="tx-create-combined-2" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">variable_detailed</th>
<th data-quarto-table-cell-role="th">value</th>
<th data-quarto-table-cell-role="th">value_type</th>
<th data-quarto-table-cell-role="th">value_source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">1</td>
<td>Texas</td>
<td>Combined</td>
<td>race</td>
<td>African American</td>
<td>267269</td>
<td>count</td>
<td>calculated</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">2</td>
<td>Texas</td>
<td>Combined</td>
<td>race</td>
<td>Asian</td>
<td>3858</td>
<td>count</td>
<td>calculated</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">3</td>
<td>Texas</td>
<td>Combined</td>
<td>race</td>
<td>Caucasian</td>
<td>342496</td>
<td>count</td>
<td>calculated</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">4</td>
<td>Texas</td>
<td>Combined</td>
<td>race</td>
<td>Hispanic</td>
<td>300447</td>
<td>count</td>
<td>calculated</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5</td>
<td>Texas</td>
<td>Combined</td>
<td>race</td>
<td>Native American</td>
<td>162</td>
<td>count</td>
<td>calculated</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">6</td>
<td>Texas</td>
<td>Combined</td>
<td>race</td>
<td>Other</td>
<td>2531</td>
<td>count</td>
<td>calculated</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
✓ Verification of Combined calculations:
  Convicted Offender total: 845,322
  Arrestee total: 73,631
  Sum: 918,953
  Combined total: 918,953
  Match: True</code></pre>
</div>
</div>
</section>
<section id="preparing-texas-data-for-the-combined-dataset" class="level3" data-number="3.7.3">
<h3 data-number="3.7.3" class="anchored" data-anchor-id="preparing-texas-data-for-the-combined-dataset"><span class="header-section-number">3.7.3</span> Preparing Texas data for the combined dataset</h3>
<div id="tx-append-to-combined" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare Texas data with only needed columns</span></span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>tx_for_combined <span class="op">=</span> prepare_state_for_combined(texas, <span class="st">"Texas"</span>)</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Update value_source for Combined rows</span></span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>tx_for_combined.loc[</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>    tx_for_combined[<span class="st">'offender_type'</span>] <span class="op">==</span> <span class="st">'Combined'</span>, </span>
<span id="cb93-7"><a href="#cb93-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'value_source'</span></span>
<span id="cb93-8"><a href="#cb93-8" aria-hidden="true" tabindex="-1"></a>] <span class="op">=</span> <span class="st">'calculated'</span></span>
<span id="cb93-9"><a href="#cb93-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-10"><a href="#cb93-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Display structure verification</span></span>
<span id="cb93-11"><a href="#cb93-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Texas data structure verification:"</span>)</span>
<span id="cb93-12"><a href="#cb93-12" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique offender types: </span><span class="sc">{</span>tx_for_combined[<span class="st">'offender_type'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb93-13"><a href="#cb93-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Unique variable categories: </span><span class="sc">{</span>tx_for_combined[<span class="st">'variable_category'</span>]<span class="sc">.</span>unique()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb93-14"><a href="#cb93-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-15"><a href="#cb93-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Append to the combined dataframe</span></span>
<span id="cb93-16"><a href="#cb93-16" aria-hidden="true" tabindex="-1"></a>foia_combined <span class="op">=</span> pd.concat([foia_combined, tx_for_combined], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb93-17"><a href="#cb93-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb93-18"><a href="#cb93-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✓ Appended </span><span class="sc">{</span><span class="bu">len</span>(tx_for_combined)<span class="sc">}</span><span class="ss"> Texas rows to foia_combined"</span>)</span>
<span id="cb93-19"><a href="#cb93-19" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Total rows in foia_combined: </span><span class="sc">{</span><span class="bu">len</span>(foia_combined)<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Texas data structure verification:
Unique offender types: ['Convicted Offender' 'Arrestee' 'Combined']
Unique variable categories: ['total' 'gender' 'race']

✓ Appended 24 Texas rows to foia_combined
✓ Total rows in foia_combined: 193</code></pre>
</div>
</div>
</section>
<section id="calculating-percentages-1" class="level3" data-number="3.7.4">
<h3 data-number="3.7.4" class="anchored" data-anchor-id="calculating-percentages-1"><span class="header-section-number">3.7.4</span> Calculating percentages</h3>
<div id="tx-calculate-percentages" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb95"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb95-1"><a href="#cb95-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate percentages using helper function</span></span>
<span id="cb95-2"><a href="#cb95-2" aria-hidden="true" tabindex="-1"></a>tx_percentages <span class="op">=</span> calculate_percentages(foia_combined, <span class="st">"Texas"</span>)</span>
<span id="cb95-3"><a href="#cb95-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-4"><a href="#cb95-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Add percentages to foia_combined</span></span>
<span id="cb95-5"><a href="#cb95-5" aria-hidden="true" tabindex="-1"></a>foia_combined <span class="op">=</span> pd.concat([foia_combined, tx_percentages], ignore_index<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb95-6"><a href="#cb95-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-7"><a href="#cb95-7" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Calculated and added </span><span class="sc">{</span><span class="bu">len</span>(tx_percentages)<span class="sc">}</span><span class="ss"> percentage rows for Texas"</span>)</span>
<span id="cb95-8"><a href="#cb95-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Total rows in foia_combined: </span><span class="sc">{</span><span class="bu">len</span>(foia_combined)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb95-9"><a href="#cb95-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-10"><a href="#cb95-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Display sample of calculated percentages</span></span>
<span id="cb95-11"><a href="#cb95-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Gender percentages by offender type:"</span>)</span>
<span id="cb95-12"><a href="#cb95-12" aria-hidden="true" tabindex="-1"></a>gender_pct <span class="op">=</span> tx_percentages[tx_percentages[<span class="st">'variable_category'</span>] <span class="op">==</span> <span class="st">'gender'</span>].pivot_table(</span>
<span id="cb95-13"><a href="#cb95-13" aria-hidden="true" tabindex="-1"></a>    index<span class="op">=</span><span class="st">'variable_detailed'</span>, columns<span class="op">=</span><span class="st">'offender_type'</span>, values<span class="op">=</span><span class="st">'value'</span></span>
<span id="cb95-14"><a href="#cb95-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb95-15"><a href="#cb95-15" aria-hidden="true" tabindex="-1"></a>display(gender_pct)</span>
<span id="cb95-16"><a href="#cb95-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb95-17"><a href="#cb95-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Verify percentages sum to ~100%</span></span>
<span id="cb95-18"><a href="#cb95-18" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Verification of percentage totals by category:"</span>)</span>
<span id="cb95-19"><a href="#cb95-19" aria-hidden="true" tabindex="-1"></a>verification <span class="op">=</span> (tx_percentages.groupby([<span class="st">'offender_type'</span>, <span class="st">'variable_category'</span>])[<span class="st">'value'</span>]</span>
<span id="cb95-20"><a href="#cb95-20" aria-hidden="true" tabindex="-1"></a>                .<span class="bu">sum</span>()</span>
<span id="cb95-21"><a href="#cb95-21" aria-hidden="true" tabindex="-1"></a>                .<span class="bu">round</span>(<span class="dv">2</span>)</span>
<span id="cb95-22"><a href="#cb95-22" aria-hidden="true" tabindex="-1"></a>                .reset_index()</span>
<span id="cb95-23"><a href="#cb95-23" aria-hidden="true" tabindex="-1"></a>                .rename(columns<span class="op">=</span>{<span class="st">'value'</span>: <span class="st">'sum_of_percentages'</span>}))</span>
<span id="cb95-24"><a href="#cb95-24" aria-hidden="true" tabindex="-1"></a>display(verification)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Calculated and added 21 percentage rows for Texas
✓ Total rows in foia_combined: 214

Gender percentages by offender type:</code></pre>
</div>
<div id="tx-calculate-percentages-1" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">Arrestee</th>
<th data-quarto-table-cell-role="th">Combined</th>
<th data-quarto-table-cell-role="th">Convicted Offender</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">variable_detailed</th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Female</td>
<td>25.43</td>
<td>15.25</td>
<td>14.37</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Verification of percentage totals by category:</code></pre>
</div>
<div id="tx-calculate-percentages-2" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">sum_of_percentages</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>Arrestee</td>
<td>gender</td>
<td>25.43</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Arrestee</td>
<td>race</td>
<td>97.06</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Combined</td>
<td>gender</td>
<td>15.25</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Combined</td>
<td>race</td>
<td>99.76</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Convicted Offender</td>
<td>gender</td>
<td>14.37</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>Convicted Offender</td>
<td>race</td>
<td>100.01</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="visualizing-texas-demographics" class="level3" data-number="3.7.5">
<h3 data-number="3.7.5" class="anchored" data-anchor-id="visualizing-texas-demographics"><span class="header-section-number">3.7.5</span> Visualizing Texas demographics</h3>
<div id="tx-visualize" class="cell" data-fig-height="16" data-fig-width="15" data-execution_count="47">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>create_state_visualizations(foia_combined, <span class="st">"Texas"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="foia_processing_files/figure-html/tx-visualize-output-1.png" id="tx-visualize-1" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
Texas profile counts by offender type:</code></pre>
</div>
<div id="tx-visualize-2" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Total Profiles</th>
</tr>
<tr class="even">
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th"></th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Convicted Offender</td>
<td>845,322.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Arrestee</td>
<td>73,631.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Combined</td>
<td>918,953.0</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="summary-of-texas-processing" class="level3" data-number="3.7.6">
<h3 data-number="3.7.6" class="anchored" data-anchor-id="summary-of-texas-processing"><span class="header-section-number">3.7.6</span> Summary of Texas processing</h3>
<p>Texas data processing complete. The state required: - Standardization of “Offenders” to “Convicted Offender” - Calculation of Combined totals across offender types - Calculation of percentages from provided counts</p>
<p>Mixed <code>value_source</code> attribution: original counts are “reported”, Combined totals and all percentages are “calculated”.</p>
</section>
</section>
</section>
<section id="conclusions" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Conclusions</h1>
<section id="final-processing-summary" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="final-processing-summary"><span class="header-section-number">4.1</span> Final Processing Summary</h2>
<p>All seven states have been successfully processed and combined into a unified dataset.</p>
<div id="final-summary-all-states" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Display final metadata summary</span></span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"State Processing Metadata:"</span>)</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"="</span> <span class="op">*</span> <span class="dv">80</span>)</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>metadata_df <span class="op">=</span> pd.DataFrame(foia_state_metadata)</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>display(metadata_df)</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Summary statistics</span></span>
<span id="cb100-8"><a href="#cb100-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"</span><span class="ch">\n</span><span class="ss">✓ Total rows in foia_combined: </span><span class="sc">{</span><span class="bu">len</span>(foia_combined)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb100-9"><a href="#cb100-9" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ States processed: </span><span class="sc">{</span><span class="bu">sorted</span>(foia_combined[<span class="st">'state'</span>].unique())<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb100-10"><a href="#cb100-10" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Offender types: </span><span class="sc">{</span><span class="bu">sorted</span>(foia_combined[<span class="st">'offender_type'</span>].unique())<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb100-11"><a href="#cb100-11" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Variable categories: </span><span class="sc">{</span><span class="bu">sorted</span>(foia_combined[<span class="st">'variable_category'</span>].unique())<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb100-12"><a href="#cb100-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-13"><a href="#cb100-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Value source breakdown</span></span>
<span id="cb100-14"><a href="#cb100-14" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Value source breakdown:"</span>)</span>
<span id="cb100-15"><a href="#cb100-15" aria-hidden="true" tabindex="-1"></a>source_counts <span class="op">=</span> foia_combined[<span class="st">'value_source'</span>].value_counts()</span>
<span id="cb100-16"><a href="#cb100-16" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> source, count <span class="kw">in</span> source_counts.items():</span>
<span id="cb100-17"><a href="#cb100-17" aria-hidden="true" tabindex="-1"></a>    pct <span class="op">=</span> (count <span class="op">/</span> <span class="bu">len</span>(foia_combined)) <span class="op">*</span> <span class="dv">100</span></span>
<span id="cb100-18"><a href="#cb100-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f"  • </span><span class="sc">{</span>source<span class="sc">}</span><span class="ss">: </span><span class="sc">{</span>count<span class="sc">}</span><span class="ss"> rows (</span><span class="sc">{</span>pct<span class="sc">:.1f}</span><span class="ss">%)"</span>)</span>
<span id="cb100-19"><a href="#cb100-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb100-20"><a href="#cb100-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Show sample of final combined data</span></span>
<span id="cb100-21"><a href="#cb100-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">Sample of final combined dataset:"</span>)</span>
<span id="cb100-22"><a href="#cb100-22" aria-hidden="true" tabindex="-1"></a>display(foia_combined.sample(<span class="dv">10</span>, random_state<span class="op">=</span><span class="dv">42</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>State Processing Metadata:
================================================================================</code></pre>
</div>
<div id="final-summary-all-states-1" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">race_report_values</th>
<th data-quarto-table-cell-role="th">gender_report_values</th>
<th data-quarto-table-cell-role="th">notes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>California</td>
<td>counts</td>
<td>counts</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>Florida</td>
<td>both</td>
<td>both</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>Indiana</td>
<td>percentages</td>
<td>percentages</td>
<td>Provides percentages for demographics, counts ...</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>Maine</td>
<td>both</td>
<td>both</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>Nevada</td>
<td>both</td>
<td>both</td>
<td>Uses 'flags' terminology instead of 'profiles'</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5</td>
<td>South Dakota</td>
<td>both</td>
<td>both</td>
<td>Includes gender_race cross-tabulation for inte...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">6</td>
<td>Texas</td>
<td>counts</td>
<td>counts</td>
<td>NaN</td>
</tr>
</tbody>
</table>

</div>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>
✓ Total rows in foia_combined: 214
✓ States processed: ['California', 'Florida', 'Indiana', 'Maine', 'Nevada', 'South Dakota', 'Texas']
✓ Offender types: ['Arrestee', 'Combined', 'Convicted Offender']
✓ Variable categories: ['gender', 'gender_race', 'race', 'total']

Value source breakdown:
  • reported: 143 rows (66.8%)
  • calculated: 71 rows (33.2%)

Sample of final combined dataset:</code></pre>
</div>
<div id="final-summary-all-states-2" class="cell-output cell-output-display">
<div>


<table class="dataframe caption-top table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">state</th>
<th data-quarto-table-cell-role="th">offender_type</th>
<th data-quarto-table-cell-role="th">variable_category</th>
<th data-quarto-table-cell-role="th">variable_detailed</th>
<th data-quarto-table-cell-role="th">value</th>
<th data-quarto-table-cell-role="th">value_type</th>
<th data-quarto-table-cell-role="th">value_source</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">9</td>
<td>California</td>
<td>Convicted Offender</td>
<td>race</td>
<td>Caucasian</td>
<td>588555.0000</td>
<td>count</td>
<td>reported</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">197</td>
<td>Texas</td>
<td>Convicted Offender</td>
<td>race</td>
<td>Hispanic</td>
<td>32.6800</td>
<td>percentage</td>
<td>calculated</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">66</td>
<td>Florida</td>
<td>Combined</td>
<td>race</td>
<td>Hispanic</td>
<td>2.4200</td>
<td>percentage</td>
<td>reported</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">191</td>
<td>Texas</td>
<td>Combined</td>
<td>race</td>
<td>Other</td>
<td>2531.0000</td>
<td>count</td>
<td>calculated</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">117</td>
<td>Nevada</td>
<td>Combined</td>
<td>gender</td>
<td>Unknown</td>
<td>0.0209</td>
<td>percentage</td>
<td>reported</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">111</td>
<td>Nevada</td>
<td>Convicted Offender</td>
<td>total</td>
<td>total_profiles</td>
<td>46.2150</td>
<td>percentage</td>
<td>reported</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">15</td>
<td>California</td>
<td>Arrestee</td>
<td>race</td>
<td>Asian</td>
<td>11191.0000</td>
<td>count</td>
<td>reported</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">86</td>
<td>Indiana</td>
<td>Combined</td>
<td>race</td>
<td>Hispanic</td>
<td>12030.0000</td>
<td>count</td>
<td>calculated</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75</td>
<td>Indiana</td>
<td>Combined</td>
<td>gender</td>
<td>Female</td>
<td>20.0000</td>
<td>percentage</td>
<td>reported</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">144</td>
<td>South Dakota</td>
<td>Combined</td>
<td>race</td>
<td>White/Caucasian</td>
<td>66.7500</td>
<td>percentage</td>
<td>reported</td>
</tr>
</tbody>
</table>

</div>
</div>
</div>
</section>
<section id="saving-processed-data" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="saving-processed-data"><span class="header-section-number">4.2</span> Saving Processed Data</h2>
<div id="save-outputs" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Define output paths</span></span>
<span id="cb103-2"><a href="#cb103-2" aria-hidden="true" tabindex="-1"></a>output_dir <span class="op">=</span> base_dir <span class="op">/</span> <span class="st">"output"</span> <span class="op">/</span> <span class="st">"foia"</span></span>
<span id="cb103-3"><a href="#cb103-3" aria-hidden="true" tabindex="-1"></a>output_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb103-4"><a href="#cb103-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-5"><a href="#cb103-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the combined dataset</span></span>
<span id="cb103-6"><a href="#cb103-6" aria-hidden="true" tabindex="-1"></a>foia_output_path <span class="op">=</span> output_dir <span class="op">/</span> <span class="st">"foia_data_clean.csv"</span></span>
<span id="cb103-7"><a href="#cb103-7" aria-hidden="true" tabindex="-1"></a>foia_combined.to_csv(foia_output_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb103-8"><a href="#cb103-8" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Saved combined FOIA data to: </span><span class="sc">{</span>foia_output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb103-9"><a href="#cb103-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-10"><a href="#cb103-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Save the metadata</span></span>
<span id="cb103-11"><a href="#cb103-11" aria-hidden="true" tabindex="-1"></a>metadata_output_path <span class="op">=</span> output_dir <span class="op">/</span> <span class="st">"foia_state_metadata.csv"</span></span>
<span id="cb103-12"><a href="#cb103-12" aria-hidden="true" tabindex="-1"></a>metadata_df.to_csv(metadata_output_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb103-13"><a href="#cb103-13" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Saved state metadata to: </span><span class="sc">{</span>metadata_output_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb103-14"><a href="#cb103-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-15"><a href="#cb103-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Create final frozen version</span></span>
<span id="cb103-16"><a href="#cb103-16" aria-hidden="true" tabindex="-1"></a>frozen_dir <span class="op">=</span> base_dir <span class="op">/</span> <span class="st">"data"</span> <span class="op">/</span> <span class="st">"v1.0"</span></span>
<span id="cb103-17"><a href="#cb103-17" aria-hidden="true" tabindex="-1"></a>frozen_dir.mkdir(parents<span class="op">=</span><span class="va">True</span>, exist_ok<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb103-18"><a href="#cb103-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-19"><a href="#cb103-19" aria-hidden="true" tabindex="-1"></a>frozen_path <span class="op">=</span> frozen_dir <span class="op">/</span> <span class="st">"foia_state_race_v1.0.csv"</span></span>
<span id="cb103-20"><a href="#cb103-20" aria-hidden="true" tabindex="-1"></a>foia_combined.to_csv(frozen_path, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb103-21"><a href="#cb103-21" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"✓ Created frozen version at: </span><span class="sc">{</span>frozen_path<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb103-22"><a href="#cb103-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb103-23"><a href="#cb103-23" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">✅ All processing complete!"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>✓ Saved combined FOIA data to: ../output/foia/foia_data_clean.csv
✓ Saved state metadata to: ../output/foia/foia_state_metadata.csv
✓ Created frozen version at: ../data/v1.0/foia_state_race_v1.0.csv

✅ All processing complete!</code></pre>
</div>
</div>
</section>
<section id="key-findings-and-notes" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="key-findings-and-notes"><span class="header-section-number">4.3</span> Key Findings and Notes</h2>
<ol type="1">
<li><p><strong>Data Completeness</strong>: All states provided total profile counts and demographic breakdowns, though reporting formats varied significantly.</p></li>
<li><p><strong>Calculated Values</strong>:</p>
<ul>
<li>California and Texas required Combined totals and percentage calculations</li>
<li>Indiana required count calculations from percentages</li>
<li>All calculated values are clearly marked with <code>value_source = "calculated"</code></li>
</ul></li>
<li><p><strong>Terminology Standardization</strong>:</p>
<ul>
<li>Nevada: “All” → “Combined”, “Arrested offender” → “Arrestee”</li>
<li>Texas: “Offenders” → “Convicted Offender”</li>
</ul></li>
<li><p><strong>Unique Features</strong>:</p>
<ul>
<li>South Dakota provided intersectional gender×race data unavailable from other states</li>
<li>Nevada uses “flags” terminology instead of “profiles”</li>
<li>California acknowledged missing race data, requiring “Unknown” category calculation</li>
</ul></li>
<li><p><strong>Data Quality</strong>: After processing, all states show internally consistent data with demographic counts summing to reported totals and percentages summing to approximately 100% (accounting for rounding).</p></li>
</ol>
<p>This standardized dataset enables direct state-to-state comparisons of DNA database demographics while maintaining full transparency about data sources and calculations.</p>
<p>This processing pipeline has successfully transformed heterogeneous FOIA responses from seven states into a standardized, analysis-ready dataset. By maintaining clear attribution of reported versus calculated values and documenting all processing decisions, this work supports reproducible research on racial disparities in DNA databases.</p>
<p>The unified dataset (<code>foia_state_race_v1.0.csv</code>) and accompanying metadata provide researchers with accessible, transparent data to examine critical questions about equity and representation in forensic DNA databases. As noted in the introduction, making this data more accessible represents an important contribution to research ethics and transparency in criminal justice studies.</p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>