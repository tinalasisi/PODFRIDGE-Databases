---
title: "Processed Data Version Freeze"
author: "Tina Lasisi"
date: today
format:
  html:
    code-fold: true
    toc: true
    toc-depth: 2
---

This notebook lets you freeze all finalized datasets (`data/*/final`) into a
single release under `data/versioned_data/`. Each run automatically stamps the
release with the current UTC datetime so you never have to manually create
version labels. Update the optional summary/note variables in the chunk below,
run the notebook, and the files will be copied into a new
`versioned_data/<timestamp>/` folder alongside an auto-generated README
summarizing the release.

## Version Configuration

Update the description fields if you want to add extra context to the release.

```{r}
#| label: version-settings
#| echo: true

version_message <- "Processed-data freeze capturing all final datasets."
version_note <- "Highlights: Add release-specific notes here."
```

## Setup

```{r}
#| label: setup
#| echo: true

library(tidyverse)
library(fs)
library(glue)
library(lubridate)
library(here)

data_root <- here("data")
processed_root <- here("data", "versioned_data")
fs::dir_create(processed_root)
```

## Determine Version Target

```{r}
#| label: determine-version
freeze_timestamp <- now(tzone = "UTC")
timestamp_label <- format(freeze_timestamp, "%Y%m%dT%H%M%SZ")
target_version <- timestamp_label
target_dir <- fs::path(processed_root, target_version)

suffix <- 1
while (fs::dir_exists(target_dir)) {
  target_version <- glue("{timestamp_label}-run{suffix}")
  target_dir <- fs::path(processed_root, target_version)
  suffix <- suffix + 1
}

fs::dir_create(target_dir)

glue("Creating processed data release: {target_version} at {target_dir}") %>% message()
glue("Release timestamp (UTC): {freeze_timestamp}") %>% message()
```

## Collect Final Datasets

```{r}
#| label: collect-datasets
#| echo: true

top_level_dirs <- fs::dir_ls(data_root, type = "directory", recurse = FALSE)
dataset_dirs <- top_level_dirs[basename(top_level_dirs) != "versioned_data"]

final_info <- purrr::map_dfr(dataset_dirs, function(ds_dir) {
  final_dir <- fs::path(ds_dir, "final")
  if (fs::dir_exists(final_dir)) {
    files <- fs::dir_ls(final_dir, recurse = TRUE, type = "file")
    tibble(
      dataset = basename(ds_dir),
      source_final = final_dir,
      files = list(files)
    )
  } else {
    NULL
  }
})

if (nrow(final_info) == 0) {
  stop("No datasets with a `final/` directory were found under data/.")
}

glue("Identified {nrow(final_info)} dataset(s) with final outputs.") %>% message()
final_info %>%
  mutate(file_count = purrr::map_int(files, length)) %>%
  select(dataset, file_count)
```

## Copy Final Files into Version Folder

```{r}
#| label: copy-files
#| echo: true

copy_results <- final_info %>%
  mutate(
    files_copied = purrr::map2(source_final, dataset, function(src, ds_name) {
      files <- fs::dir_ls(src, recurse = TRUE, type = "file")
      if (length(files)) {
        purrr::map(files, function(file_path) {
         relative <- fs::path_rel(file_path, start = src)
          target_name <- relative
          dest_file <- fs::path(target_dir, target_name)
          fs::dir_create(fs::path_dir(dest_file))
          fs::file_copy(file_path, dest_file, overwrite = TRUE)
          target_name
        })
      } else {
        character()
      }
    })
  )

copy_results %>%
  transmute(
    dataset,
    files = purrr::map_int(files_copied, length)
  )
```

## Generate README

```{r}
#| label: create-readme
#| echo: true

readme_path <- fs::path(target_dir, "README.md")

readme_lines <- c(
  "# Processed Data Release",
  "",
  glue("- Version: {target_version}"),
  glue("- Frozen on: {format(freeze_timestamp, '%Y-%m-%d %H:%M:%S %Z')}"),
  glue("- Summary: {version_message}"),
  glue("- Notes: {version_note}"),
  "",
  glue("All files listed below now live in `data/versioned_data/{target_version}/`."),
  ""
)

file_listing <- purrr::map2_dfr(
  copy_results$files_copied,
  copy_results$source_final,
  function(files, src) {
    if (!length(files)) return(tibble(source_path = character()))
    tibble(
      source_path = fs::path_rel(fs::path(src, files), start = here())
    )
  }
)

readme_lines <- c(readme_lines, "## Source Files", "")

if (nrow(file_listing) == 0) {
  readme_lines <- c(readme_lines, "- (no files found in final directories)")
} else {
  readme_lines <- c(readme_lines, paste0("- `", file_listing$source_path, "`"))
}

writeLines(readme_lines, readme_path)
glue("README written to {readme_path}") %>% message()
```

## Summary

```{r}
#| label: summary
#| echo: true

copy_results %>%
  transmute(
    dataset,
    files_copied = purrr::map_int(files_copied, length),
    example_file = purrr::map_chr(files_copied, function(x) {
      if (length(x) == 0) "(none)" else as.character(x[[1]])
    })
  )
```
